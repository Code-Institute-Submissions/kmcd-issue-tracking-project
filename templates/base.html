{% load staticfiles %}

<html>

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!-- The CI video used a local fontawesome, but it didnt work either locally or from S3, so I'm using the Fontawesome CDN -->

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

    <link rel="stylesheet" href="{% static 'css/styles.css' %}" type="text/css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <link rel="shortcut icon" href="{% static 'images/kmcd_acc_sol_icon.ico' %}" />

    <!-- This will allow us to change the title of the page depending on
             the user options -->
    <title>{% block page_title %}{% endblock %}</title>

</head>

<body>

    <header>

        {% if user.is_authenticated %} {% if userdetails.user_type == "V" %}

        <!-- User is logged in and is associated with the Vendor.
             Show Vendor Name and User Name at the top of the screen -->

        <div class="row no-gutters vend-client-user ">
            <div class="col-6 mb-0">
                <p class="nav-c-v-name m-0">{{ vendordetails.vend_name }}
            </div>
            <div class="col-6">
                <p class="nav-c-v-user m-0">Welcome, {{ userdetails.user_first_name }}!</p>
            </div>
        </div>

        {% else %}

        <!-- User is logged in and is associated with the client.
             Show client Name and User Name at the top of the screen -->

        <div class="row no-gutters vend-client-user ">
            <div class="col-6">
                <p class="nav-c-v-name m-0">{{ clientdetails.client_name }}
            </div>
            <div class="col-6">
                <p class="nav-c-v-user m-0">Welcome, {{ userdetails.user_first_name }}!</p>
            </div>
        </div>
        {% endif %} {% else %}

        <!-- No user logged in yet - leave a blank row where vendor / client 
             name and user name will be shown-->

        <div class="row no-gutters vend-client-user">

        </div>

        {% endif %}

        <!-- Show the navigation bar -->

        <nav class="navbar navbar-expand-lg navbar-light navbar-style nav-links">
            <div class="nav-logo">
                <a class="navbar-brand logo" href="{% url 'home' %}"></a>
            </div>

            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse  navbar-padding" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto ">
                    <li class="nav-item"><a class="nav-link" href="{% url 'home' %}"><i id="home" class="fa fa-home home-icon" aria-hidden="true"></i></a></li>

                    <!-- Show relevant links depending on whether the user is logged in or not -->

                    {% if user.is_authenticated %}
                    <li class="nav-item"><a class="nav-link" href="{% url 'profile' %}">Profile</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'logout' %}">Logout</a></li>
                    <li class="nav-item nav-issues-align"><a class=" btn iss-btn-color iss-button-font iss-nav-link" href="{% url 'user_home' %}"><i class="fas fa-list pr-1"></i>ISSUES</a></li>



                    {%if userdetails.user_type == "C" %}

                    <!-- Only Client-side users can enter issues -->

                    <li class="nav-item iss-ftr-ml"><a class="btn iss-btn-color iss-button-font iss-nav-link" href="{% url 'new_issue' %}"><i class="fas fa-plus pr-1"></i>ISSUE</a></li>


                    {% else %}

                    <!-- Keep the space but blank it out (background and color will be the same). This is so
                         that 'Features' (below) will always appear in the same space on the navbar-->

                    <li class="nav-blank">New Issue</a>
                    </li>
                    {% endif %}

                    <li class="nav-item iss-ftr-gap"><a class=" btn ftr-btn-color ftr-button-font ftr-nav-link" href="{% url 'features_home' %}" data-value="MY FEATURES"><i class="fas fa-list pr-1"></i>FEATURES</a></li>

                    <!-- Only Client-side users can enter new features -->

                    {%if userdetails.user_type == "C" %}

                    <li class="nav-item iss-ftr-ml"><a href="{% url 'new_feature' %}" class="btn ftr-btn-color ftr-button-font ftr-nav-link" data-value="ADD FEATURE"><i class="fas fa-plus pr-1"></i>FEATURE</a>

                        <!-- Shopping cart is shown for client-side users only.  
                         Add shopping cart - code copied from e-commerce product-->

                        <li class="cart-container">
                            <a class="cart-color cart-button-font cart-nav-link" href="{% url 'view_cart' %}"><i class="fas fa-shopping-cart"></i> Cart
                            {% if product_count > 0 %}
                            <!-- This will show how many items are in the cart -->
                            <label class="badge badge-warning">{{ feature_count }}</label>
                            {% endif %}</a>
                        
                        </li>


                        {% else %}

                        <!-- Keep the space but blank it out (background and color will be the same). This is so
                         that 'Features' (below) will always appear in the same space on the navbar-->

                        <li class="nav-blank">New Feature</a>
                        </li>


                        {% endif %} {% else %}
                        <!-- User is not logged in -->

                        <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Login</a></li>
                        <li class="nav-item"><a class="nav-link" href="{% url 'registration' %}">Register</a></li>
                        {% endif %}

                </ul>
            </div>
        </nav>
    </header>

    <section class="pg-bg">

        <!-- A line is kept just below the navbar to display messages -->

        <div class="row no-gutters">
            <div class="offset-2 col-8 p-0">

                <ul class="mesg-style p-0  text-center">
                    {% if messages %} {% for message in messages %}
                    <li class="user-message">{{ message }}</li>
                    {% endfor%} {% else %}
                    <li class="user-message blank-line">blank</li>
                    {% endif %}
                </ul>

            </div>
        </div>

        {% block content %}{% endblock %}

    </section>



    <!-- Pagination 
         This is used by both the issues list and the features list.
         Both issues and features are passed back in 'listing' so that the
         pagination variables will be picked up 
         Specific classes prefixed with 'iss- are added for issue; and classes
         prefixed with 'ftr-' are added for features. This is because the 
         highlighter color is different for each  -->

    <nav id="paginate" class="pag-nav-section" aria-label="Page navigation">
        {% if listing.has_other_pages %}

        <ul class="pagination justify-content-center mt-3">

            {% if listing.has_previous %} 
            
                <!-- Add the correct classes depending on whether its the issue list ('iss-') or the 
                     features list ('ftr-')  -->
                 
                {% if list_type == "issues" %}

                <li class="page-item"><a class="page-link iss-page-live-link" href="?page={{ listing.previous_page_number }}">&laquo;</a></li>

                {% else %}

                <li class="page-item"><a class="page-link ftr-page-live-link" href="?page={{ listing.previous_page_number }}">&laquo;</a></li>

                {% endif %} 
                
            {% else %}

                <li class="page-item"><span class="page-link">&laquo;</span></li>
                
                {% endif %} 
                
                <!-- Output the other page numbers -->
                
                {% for i in listing.paginator.page_range %} 
                
                    {% if listing.number == i %}

                    <!-- Add the correct classes depending on whether its the issue list ('iss-') or the 
                         features list ('ftr-')  -->

                        {% if list_type == "issues" %}

                            <li class="page-item"><span class="page-link iss-selected">{{ i }} <span class="sr-only">(current)</span></span>
                            </li>

                        {% else %}

                            <li class="page-item"><span class="page-link ftr-selected">{{ i }} <span class="sr-only">(current)</span></span>
                            </li>

                        {% endif %} 
                        
                    {% else %}

                        <!-- Add the correct classes depending on whether its the issue list ('iss-') or the 
                             features list ('ftr-')  -->

                    {% if list_type == "issues" %}

                        <li class="page-item"><a class="page-link iss-page-live-link" href="?page={{ i }}">{{ i }}</a></li>

                    {% else %}

                        <li class="page-item"><a class="page-link ftr-page-live-link" href="?page={{ i }}">{{ i }}</a></li>


                    {% endif %} 
                    
                {% endif %} 
                
            {% endfor %} 
            
            {% if listing.has_next %} 
            
                 <!-- Add the correct classes depending on whether its the issue list ('iss-') or the 
                     features list ('ftr-')  -->
                 
                {% if list_type == "issues" %}

                <li class="page-item"><a class="page-link iss-page-live-link" href="?page={{ listing.next_page_number }}">&raquo;</a></li>

                {% else %}

                <li class="page-item"><a class="page-link ftr-page-live-link" href="?page={{ listing.next_page_number }}">&raquo;</a></li>

                {% endif %} 
            
            {% else %}

                <li class="page-item"><span class="page-link">&raquo;</span></li>
            {% endif %}

        </ul>
        {% endif %}
    </nav>


    <footer>
    </footer>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js " integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin=" anonymous "></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>


    <!-- Custom Javascript -->


    <script>
        // The following script manages the Filtering and Pagination of Issues 
        // and Features when selections are made from the dropdown filters


        $(document).ready(function() {

            // ISSUES PROCESSING -------------------------------------------//

            // ===========================
            // Filtering by Issue Filter 
            // ===========================

            // A value has been selected by the user from the Issues Filter 
            // dropdown 

            $('.issue-filter').on('click', function() {

                event.preventDefault();
                let issuesFilter = $(this).data('value');

                console.log("issuesFilter : " + issuesFilter)

                // Change the value showing in the dropdown box to the new 
                // value selected by the user

                $('#dropdownMenuLink-1').text(issuesFilter);

                // When the user selects a value from the Issues Filter, all the
                // other filters are reset to "ALL"

                // Reset Status Filter to "ALL" and display it in the filter
                // dropdown box

                let statusFilter = "ALL"
                $('#dropdownMenuLink-2').text(statusFilter);

                // Reset Priority Filter to "ALL" and display it in the filter
                // dropdown box

                let priorityFilter = "ALL"
                $('#dropdownMenuLink-3').text(priorityFilter);

                // Reset Client Filter to "ALL". If this is a client-side 
                // user, the Client Code dropdown option wont be displayed on
                // screen. If its a vendor-side user, display "ALL" in the 
                // Client dropdown box

                let clientFilter = "ALL";

                if ($("#dropdownMenuLink-4").length > 0) {

                    $('#dropdownMenuLink-4').text(clientFilter);
                }

                // Get the issues requested by the user, as per the filter
                // values, starting with page 1

                let page = 1;

                getIssues(issuesFilter, statusFilter, priorityFilter, clientFilter, page);

            });


            // ===========================
            // Filtering by Status Filter
            // ===========================

            // A value has been selected from the Status filter dropdown by the user

            $('.iss-status-filter').on('click', function() {

                event.preventDefault();
                let statusFilter = $(this).data('value');


                // Change the value showing in the dropdown box to the new 
                // value selected by the user

                $('#dropdownMenuLink-2').text(statusFilter);

                // When the status filter is selected, it will be used in
                // conjunction with the current values of the other 2 filters

                // Get the current value of the Issues Filter

                let issuesFilter = getIssuesFilterValue();

                // Get the current value of the Priority Filter

                let priorityFilter = getPriorityFilterValue();

                // Get the current value of the Client Filter, if it's an
                // option on the screen, otherwise set it to "ALL"

                let clientFilter = getClientFilterValue();

                // Get the issues requested by the user, as per the filter
                // values, starting with page 1

                let page = 1;

                console.log("in status filter click")
                console.log("statusFilter: " + statusFilter);
                console.log("issuesFilter: " + issuesFilter);
                console.log("priorityFilter: " + priorityFilter);
                console.log("clientFilter: " + clientFilter);

                getIssues(issuesFilter, statusFilter, priorityFilter, clientFilter, page);
            });


            // ===========================
            // Filtering by Priority
            // ===========================

            $('.priority-filter').on('click', function() {

                event.preventDefault();

                let priorityFilter = $(this).data('value');
                let priorityFilterText = this.innerText;


                // A value has been selected from the Priority Filter dropdown 
                // by the user

                // Change the value showing in the dropdown box to the new 
                // value selected by the user

                $('#dropdownMenuLink-3').text(priorityFilterText);

                // When the priority filter is selected, it will be used in
                // conjunction with the current values of the other 2 filters

                // Get the current value of the Issues Filter

                let issuesFilter = getIssuesFilterValue();

                // Get the current value of the Status Filter

                let statusFilter = getStatusFilterValue();

                // Get the current value of the Client Filter, if it's an
                // option on the screen, otherwise set it to "ALL"

                let clientFilter = getClientFilterValue();

                // Get the issues requested by the user, as per the filter
                // values, starting with page 1

                let page = 1;

                getIssues(issuesFilter, statusFilter, priorityFilter, clientFilter, page);
            });


            // ===========================
            // Filtering by Client Filter 
            // ===========================

            // Client Filter has been selected by the user. The Client Filter
            // will only be available when the user is a vendor-side user

            $('.iss-client-filter').on('click', function() {

                event.preventDefault();
                let clientFilter = $(this).data('value');

                // A value has been selected from the Client Filter dropdown by
                // the user

                // Change the value showing in the dropdown box to the new 
                // value selected by the user

                $('#dropdownMenuLink-4').text(clientFilter);

                // When the client filter is selected, it will be used in
                // conjunction with the current values of the other 2 filters

                // Get the current value of the Issues Filter

                let issuesFilter = getIssuesFilterValue();

                // Get the current value of the Status Filter

                let statusFilter = getStatusFilterValue();

                // Get the current value of the Priority Filter

                let priorityFilter = getPriorityFilterValue();


                // Get the issues requested by the user, as per the filter
                // values, starting with page 1

                let page = 1;

                getIssues(issuesFilter, statusFilter, priorityFilter, clientFilter, page);
            });


            // ===========================
            // Issues Pagination
            // ===========================

            // The user has clicked on a page number
            // Using "$(document).on . . ." here because the 'iss-page-click' 
            // class is not part of the html when it is first loaded, they are
            // added by js when it displays the filtered data, and therefore the
            // js wont respond to "$('.iss-page-click').on('click', function()"

            $(document).on('click', ".iss-page-click", function() {

                    // Get the page number the user clicked on

                    var page = $(this).data('value');

                    console.log("in iss-page-click");

                    console.log("this page: " + page);

                    // Get the current values of the filters

                    let issuesFilter = getIssuesFilterValue();
                    let statusFilter = getStatusFilterValue();
                    let priorityFilter = getPriorityFilterValue();
                    let clientFilter = getClientFilterValue();

                    console.log("priorityFilter: " + priorityFilter);

                    // Get the issues as per the filter values and page number

                    getIssues(issuesFilter, statusFilter, priorityFilter, clientFilter, page);
                }

            );

            // ================
            // HELPER FUNCTIONS
            // ================
            // Get the current value of the issues filter

            function getIssuesFilterValue() {

                // Get the current value of the Issues Filter

                let el = document.getElementById("dropdownMenuLink-1");
                let issuesFilter = el.innerText;

                return issuesFilter;

            }

            // Get the current value of the Status Filter

            function getStatusFilterValue() {

                let el = document.getElementById("dropdownMenuLink-2");

                let statusFilter = el.innerText;

                return statusFilter;

            }

            // Get the current value of the Priority Filter
            // The priority in the db is just a number from 1 - 5. But on the 
            // screen a descriptive text is included, e.g. 1 - URGENT. When
            // getting the value of the current priority filter, the '1' must
            // be extracted from the text.

            function getPriorityFilterValue() {

                let el = document.getElementById("dropdownMenuLink-3");
                let priorityFilter = el.innerText

                if (el.innerText != "ALL") {

                    let priorityArray = el.innerText.split("");
                    console.log("in getPriorityFilterValue.  priorityArray[0,0]: " + priorityArray[0, 0])
                    priorityFilter = priorityArray[0, 0];
                }

                console.log("in getPriorityFilterValue. priorityFilter: " + priorityFilter)

                return priorityFilter;

            }


            // Get the current value of the Client Filter, if it's an
            // option on the screen, otherwise set it to "ALL"

            function getClientFilterValue() {

                let clientFilter = "ALL";

                if ($("#dropdownMenuLink-4").length > 0) {

                    let el = document.getElementById("dropdownMenuLink-4");

                    clientFilter = el.innerText;
                }

                return clientFilter;

            }


            // =================================
            // Get the issues from the database 
            // =================================

            // Get the relevant issues, based on the value of the filters


            function getIssues(issuesFilter, statusFilter, priorityFilter, clientFilter, page) {

                console.log("in getIssues(). page = " + page)

                $.post({
                    url: "{% url 'get_issues' %}",
                    data: {
                        csrfmiddlewaretoken: "{{csrf_token}}",
                        issuesFilter: issuesFilter,
                        statusFilter: statusFilter,
                        priorityFilter: priorityFilter,
                        clientFilter: clientFilter,
                        page: page,

                    },

                    success: function(data) {


                        // Display user message if one is returned
                        // If the message is blank, keep the line, but make
                        // it invisible on the screen

                        var userMessage = data.user_mesg.user_message;

                        if (userMessage != "") {
                            console.log("userMessage: " + userMessage)
                            $('.user-message').text(userMessage)
                            $('.user-message').removeClass('blank-line')
                        }
                        else {
                            $('.user-message').text("blank")
                            $('.user-message').addClass('blank-line')
                        }


                        // Clear the current contents of the table
                        // Output the details of each issue to the table 

                        $("tbody").empty();
                        $.each(data.issues, function(key, value) {

                            var issueId = value.id;

                            var inputDate = value.date;
                            var user = value.user;

                            if (value.user_type == "C") {
                                var assignedUser = value.assigned_client_user;
                            }
                            else {
                                var assignedUser = value.assigned_vendor_user;
                            }

                            var softwareComponent = value.software_component;
                            var priority = value.priority;
                            var summary = value.summary;
                            var status = value.status;

                            var issuesFilter = "ALL"
                            var statusFilter = "ALL"
                            var priorityFilter = "ALL"
                            var clientFilter = "ALL"

                            // Output the Issue Details to the table, including the 'more' icon in the last cell

                            $("tbody").append(
                                "<tr><td class='d-table-cell td-date'>" + inputDate + "</td><td class='d-md-table-cell td-username'>" + user + "</td><td class='d-md-table-cell td-username'>" + assignedUser + "</td><td class='d-md-table-cell td-sw-comp'>" + softwareComponent + "</td><td class='text-center td-priority'>" + priority + "</td><td class='td-summary'>" + summary + "</td><td class='text-center td-status'>" + status + "</td><td class='text-center more-icon-cell td-more'><a class='more-icon-style' href=/issue_tracker/" + issueId + "/ " + "><i class='fas fa-ellipsis-h more-icon-style'></i></a></td></tr>"
                            );

                            console.log("input date: " + inputDate + " user:  " + user + " summary: " + summary);

                        });


                        // Output the pagination parameters for the issues list to the html page

                        let listDesc = "issues"
                        outputPaginationValues(data, listDesc)

                    },
                    traditional: true
                }).done();
            }


            // FEATURES PROCESSING -------------------------------------------//

            // The following script manages the filtering of features by Features Filter,
            // Status Filter, Paid Filter, and Client Filter (vendor-side users only)

            // ============================
            // Filtering by Features Filter
            // ============================

            // A value has been selected from the  Features Filter dropdown 
            // by the user

            $('.features-filter').on('click', function() {

                event.preventDefault();
                let featuresFilter = $(this).data('value');

                console.log("featuresFilter : " + featuresFilter)

                // The user has selected a value from the Features Filter dropdown

                // Change the value showing in the dropdown box to the new 
                // value selected by the user

                $('#dropdownMenuLink-1').text(featuresFilter);

                // When the user selects a value from the Features Filter, all the
                // other filters are reset to "ALL"

                // Reset Status Filter to "ALL" and display it in the filter
                // dropdown box

                let statusFilter = "ALL"
                $('#dropdownMenuLink-2').text(statusFilter);

                // Reset Paid Filter to "ALL" and display it in the filter
                // dropdown box

                let paidFilter = "ALL"
                $('#dropdownMenuLink-3').text(paidFilter);

                // Reset Client Filter to "ALL". If this is a client-side 
                // user, the Client Code dropdown option wont be displayed on
                // screen. If its a vendor-side user, display "ALL" in the 
                // Client dropdown box

                let clientFilter = "ALL";

                if ($("#dropdownMenuLink-4").length > 0) {

                    $('#dropdownMenuLink-4').text(clientFilter);
                }

                // Get the features requested by the user, as per the filter
                // values, starting with page 1

                let page = 1;

                getFeatures(featuresFilter, statusFilter, paidFilter, clientFilter, page);

            });


            // ===========================
            // Filtering by Status Filter
            // ===========================

            // Status filter has been selected by the user

            $('.feat-status-filter').on('click', function() {

                event.preventDefault();
                let statusFilter = $(this).data('value');

                // The user has selected a value from the Status Filter dropdown
                // Change the value showing in the dropdown box to the new 
                // value selected by the user

                $('#dropdownMenuLink-2').text(statusFilter);

                // When the status filter is selected, it will be used in
                // conjunction with the current values of the other 2 filters

                // Get the current value of the Features Filter

                let featuresFilter = getFeaturesFilterValue();

                // Get the current value of the Paid Filter

                let paidFilter = getPaidFilterValue();

                // Get the current value of the Client Filter, if it's an
                // option on the screen, otherwise set it to "ALL"

                let clientFilter = getClientFilterValue();

                // Get the features requested by the user, as per the filter
                // values, starting with page 1

                let page = 1;

                console.log("in status filter click")
                console.log("statusFilter: " + statusFilter);
                console.log("featuresFilter: " + featuresFilter);
                console.log("paidFilter: " + paidFilter);
                console.log("clientFilter: " + clientFilter);

                getFeatures(featuresFilter, statusFilter, paidFilter, clientFilter, page);
            });



            // ==================
            // Filtering by Paid
            // ==================

            $('.paid-filter').on('click', function() {

                event.preventDefault();

                let paidFilter = $(this).data('value');
                let paidFilterText = this.innerText;

                // The user has selected a value from the Paid Filter dropdown

                // Change the value showing in the dropdown box to the new 
                // value selected by the user

                $('#dropdownMenuLink-3').text(paidFilterText);

                // When the priority filter is selected, it will be used in
                // conjunction with the current values of the other 2 filters

                // Get the current value of the Features Filter

                let featuresFilter = getFeaturesFilterValue();

                // Get the current value of the Status Filter

                let statusFilter = getStatusFilterValue();

                // Get the current value of the Client Filter, if it's an
                // option on the screen, otherwise set it to "ALL"

                let clientFilter = getClientFilterValue();

                // Get the features requested by the user, as per the filter
                // values, starting with page 1

                let page = 1;

                getFeatures(featuresFilter, statusFilter, paidFilter, clientFilter, page);
            });


            // ==========================
            // Filtering by Client Filter 
            // ==========================

            // Client Filter has been selected by the user. The Client Filter
            // will only be available when the user is a vendor-side user

            $('.feat-client-filter').on('click', function() {

                event.preventDefault();
                let clientFilter = $(this).data('value');

                // The user has selected a value from the Client Filter dropdown

                // Change the value showing in the dropdown box to the new 
                // value selected by the user

                $('#dropdownMenuLink-4').text(clientFilter);

                // When the client filter is selected, it will be used in
                // conjunction with the current values of the other 2 filters

                // Get the current value of the Features Filter

                let featuresFilter = getFeaturesFilterValue();

                // Get the current value of the Status Filter

                let statusFilter = getStatusFilterValue();

                // Get the current value of the Priority Filter

                let paidFilter = getPaidFilterValue();

                // Get the features requested by the user, as per the filter
                // values, starting with page 1

                let page = 1;

                getFeatures(featuresFilter, statusFilter, paidFilter, clientFilter, page);
            });


            // ===========================
            // Features Pagination
            // ===========================

            // The user has clicked on a page number
            // Using "$(document).on . . ." here because the 'feat-page-click' 
            // class is not part of the html when it is first loaded, they are
            // added by js when it displays the filtered data, and therefore the
            // js wont respond to "$('.iss-page-click').on('click', function()"

            $(document).on('click', ".feat-page-click", function() {

                    // Get the page number the user clicked on

                    var page = $(this).data('value');

                    console.log("in feat-page-click");

                    console.log("this page: " + page);

                    // Get the current values of the filters

                    let featuresFilter = getFeaturesFilterValue();
                    let statusFilter = getStatusFilterValue();
                    let paidFilter = getPaidFilterValue();
                    let clientFilter = getClientFilterValue();

                    console.log("paidFilter: " + paidFilter);

                    // Get the features as per the filter values and page number

                    getFeatures(featuresFilter, statusFilter, paidFilter, clientFilter, page);
                }

            );


            // ================
            // HELPER FUNCTIONS
            // ================

            // Get the current value of the Features Filter

            function getFeaturesFilterValue() {

                // Get the current value of the Features Filter

                let el = document.getElementById("dropdownMenuLink-1");
                let featuresFilter = el.innerText;

                return featuresFilter;

            }


            // Get the current value of the Paid Filter

            function getPaidFilterValue() {

                let el = document.getElementById("dropdownMenuLink-3");
                let paidFilter = el.innerText

                if (el.innerText != "ALL") {

                    let paidArray = el.innerText.split("");
                    console.log("in getPaidFilterValue.  paidArray[0,0]: " + paidArray[0, 0])
                    paidFilter = paidArray[0, 0];
                }

                console.log("in getPaidFilterValue. paidFilter: " + paidFilter)

                return paidFilter;

            }


            // ====================
            // PAGINATION FUNCTION
            // ====================

            // Get the pagination parameters passed from 
            // views.get_features and output them to the html page,
            // so that the user can select the pages

            function outputPaginationValues(data, listDesc) {

                var has_other_pages = data.pagination_props.has_other_pages;
                var has_prev_page = data.pagination_props.has_prev_page;
                var current_page = data.pagination_props.current_page;
                var has_next_page = data.pagination_props.has_next_page;
                var prev_page_nr = data.pagination_props.prev_page_nr;
                var next_page_nr = data.pagination_props.next_page_nr;
                var page_range = data.pagination_props.page_range;

                // Clear the pagination nav, in case we only have one page

                $("#paginate").empty();

                // NOTE: The html elements weren't rendering correctly when I output the values straight
                // to the <ul> / <li> e.g. it was adding </ul> / </li> in places where I didnt want them. 
                // To get around the problem I output the html elements to a variable first, then output it
                // to the html element. This worked.

                if (has_other_pages) {

                    if (has_prev_page) {

                        if (listDesc == "issues") {

                            // Output the class 'iss-page-click' or 'feat-page-click', depending on whether the
                            // list being paginated is for Issues or Features, so that the correct js functions will be 
                            // triggered for each list
                            // Also Output the class 'iss-page-live-link' or 'ftr-page-live-link', depending on whether the
                            // list being paginated is for Issues or Features, so that they will be highlighted with the correct
                            // color or hover

                            var prevPageLink = "<ul class='pagination justify-content-center mt-3'><li class='page-item'><a class='page-link iss-page-live-link iss-page-click' href='#' data-value=" + prev_page_nr + " aria-label='Previous'>&laquo;</a></li>";
                        }
                        else {
                            prevPageLink = "<ul class='pagination justify-content-center mt-3'><li class='page-item'><a class='page-link ftr-page-live-link feat-page-click' href='#' data-value=" + prev_page_nr + " aria-label='Previous'>&laquo;</a></li>";
                        }
                    }

                    else {
                        prevPageLink = "<ul class='pagination justify-content-center mt-3'><li class='page-item'><span class='page-link' aria-label='Next'>&laquo;</span></li>";

                    }

                    // Output the pagination values to the html page

                    var pageLinks = "";
                    var i = 0;

                    for (i in page_range) {

                        if (current_page === page_range[i]) {

                            if (pageLinks == "") {

                                if (listDesc == "issues") {

                                    // Output the class 'iss-selected' or 'ftr-selected' depending on whether this is the
                                    // issues list or features list, so that the highlight color for each will be applied

                                    pageLinks = "<li class='page-item'><span class='page-link iss-selected'>" + page_range[i] + "<span class='sr-only'>(current)</span></span></li>";
                                }
                                else {
                                    pageLinks = "<li class='page-item'><span class='page-link ftr-selected'>" + page_range[i] + "<span class='sr-only'>(current)</span></span></li>";
                                }

                            }
                            else {

                                if (listDesc == "issues") {

                                    // Output the class 'iss-selected' or 'ftr-selected' depending on whether this is the
                                    // issues list or features list, so that the highlight color for each will be applied

                                    pageLinks = pageLinks + "<li class='page-item'><span class='page-link iss-selected'>" + page_range[i] + "<span class='sr-only'>(current)</span></span></li>";
                                }
                                else {
                                    pageLinks = pageLinks + "<li class='page-item'><span class='page-link ftr-selected'>" + page_range[i] + "<span class='sr-only'>(current)</span></span></li>";
                                }
                            }
                        }
                        else {

                            if (pageLinks == "") {

                                // Output the class 'iss-page-click' or 'feat-page-click', depending on whether the
                                // list being paginated is for Issues or Features, so that the correct js functions will be 
                                // triggered for each list
                                // Also Output the class 'iss-page-live-link' or 'ftr-page-live-link', depending on whether the
                                // list being paginated is for Issues or Features, so that they will be highlighted with the
                                // correct color on hover

                                if (listDesc == "issues") {
                                    pageLinks = "<li class='page-item'><a class='page-link iss-page-live-link iss-page-click' href='#' data-value=" + page_range[i] + ">" + page_range[i] + "</a></li>";
                                }
                                else {
                                    pageLinks = "<li class='page-item'><a class='page-link ftr-page-live-link feat-page-click' href='#' data-value=" + page_range[i] + ">" + page_range[i] + "</a></li>";

                                }
                            }
                            else {

                                // Output the class 'iss-page-click' or 'feat-page-click', depending on whether the
                                // list being paginated is for Issues or Features, so that the correct js functions will be 
                                // triggered for each list
                                // Also Output the class 'iss-page-live-link' or 'ftr-page-live-link', depending on whether the
                                // list being paginated is for Issues or Features, so that they will be highlighted with the
                                // correct color on hover

                                if (listDesc == 'issues') {
                                    pageLinks = pageLinks + "<li class='page-item'><a class='page-link iss-page-live-link iss-page-click' href='#' data-value=" + page_range[i] + ">" + page_range[i] + "</a></li>";
                                }
                                else {

                                    pageLinks = pageLinks + "<li class='page-item'><a class='page-link ftr-page-live-link feat-page-click' href='#' data-value=" + page_range[i] + ">" + page_range[i] + "</a></li>";
                                }

                            }
                        }

                    }

                    if (has_next_page) {

                        // Output the class 'iss-page-click' or 'feat-page-click', depending on whether the
                        // list being paginated is for Issues or Features

                        if (listDesc == "issues") {

                            var nextPageLink = "<li class='page-item'><a class='page-link iss-page-live-link iss-page-click' href='#' data-value=" + next_page_nr + ">&raquo;</a></li>";
                        }
                        else {

                            var nextPageLink = "<li class='page-item'><a class='page-link ftr-page-live-link feat-page-click' href='#' data-value=" + next_page_nr + ">&raquo;</a></li>";
                        }

                    }
                    else {

                        nextPageLink = "<li class='page-item'><span class='page-link'>&raquo;</span></li>";

                    }

                    var pageNav = prevPageLink + pageLinks + nextPageLink + "</ul>";


                    $("#paginate").append(
                        pageNav
                    );
                }
            }


            // =================================
            // Get the features from the database 
            // =================================

            // Get the relevant features, based on the value of the filters

            function getFeatures(featuresFilter, statusFilter, paidFilter, clientFilter, page) {

                console.log("in getFeatures(). page = " + page)

                $.post({
                    url: "{% url 'get_features' %}",

                    data: {
                        csrfmiddlewaretoken: "{{csrf_token}}",
                        featuresFilter: featuresFilter,
                        statusFilter: statusFilter,
                        paidFilter: paidFilter,
                        clientFilter: clientFilter,
                        page: page,

                    },

                    success: function(data) {

                        console.log("after success")

                        // Display user message if one is returned
                        // If the message is blank, keep the line space, but make
                        // it invisible on the screen

                        var userMessage = data.user_mesg.user_message;
                        console.log("have user_message")

                        if (userMessage != "") {
                            console.log("userMessage: " + userMessage);
                            $('.user-message').text(userMessage);
                            $('.user-message').removeClass('blank-line');
                        }
                        else {
                            $('.user-message').text("blank");
                            $('.user-message').addClass('blank-line');
                        }


                        // Clear the current contents of the table
                        // Output the details of each feature to the table 

                        $("tbody").empty();
                        $.each(data.features, function(key, value) {

                            console.log("in table body")

                            var featureId = value.id;

                            var inputDate = value.date;
                            var user = value.user;

                            if (value.user_type == "C") {
                                var assignedUser = value.assigned_client_user;
                            }
                            else {
                                var assignedUser = value.assigned_vendor_user;
                            }

                            var softwareComponent = value.software_component;
                            var paid = value.paid;
                            var summary = value.summary;
                            var status = value.status;

                            var featuresFilter = "ALL"
                            var statusFilter = "ALL"
                            var paidFilter = "ALL"
                            var clientFilter = "ALL"

                            // Output the Feature Details to the table, including the 'more' icon in the last cell

                            $("tbody").append(
                                "<tr><td class='d-table-cell td-date'>" + inputDate + "</td><td class='d-md-table-cell td-username'>" + assignedUser + "</td><td class='d-md-table-cell td-sw-comp'>" + softwareComponent + "</td><td class='text-center td-priority'>" + paid + "</td><td class='td-summary'>" + summary + "</td><td class='text-center td-status'>" + status + "</td><td class='text-center more-icon-cell td-more'><a class='more-icon-style' href=/issue_tracker/features/" + featureId + "/ " + "><i class='fas fa-ellipsis-h more-icon-style'></i></a></td></tr>"
                            );

                            console.log("input date: " + inputDate + " user:  " + user + " summary: " + summary);

                        });

                        // Output the pagination parameters for the features list to the html page

                        let listDesc = "features"
                        outputPaginationValues(data, listDesc);

                    },
                    traditional: true
                }).done();
            }
        });
    </script>

</body>


</html>
