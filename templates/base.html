{% load staticfiles %}

<html>

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <!-- The CI video used a local fontawesome, but it didnt work either locally or from S3, so I'm using the Fontawesome CDN -->

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

    <link rel="stylesheet" href="{% static 'css/styles.css' %}" type="text/css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.4.1.min.js " integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin=" anonymous "></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js " integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1 " crossorigin="anonymous "></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js " integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM " crossorigin="anonymous "></script>

    <link rel="shortcut icon" href="{% static 'images/kmcd_acc_sol_icon.ico' %}" />

    <!-- This will allow us to change the title of the page depending on
             the user options -->
    <title>{% block page_title %}{% endblock %}</title>

    <!-- The js we're writing in checkout.html (head_js) will injected into base.html 
         here when checkout is clicked -->

    {% block head_js %} {% endblock %}

</head>

<body>

    <header>

        {% if user.is_authenticated %} {% if userdetails.user_type == "V" %}

        <!-- User is logged in and is associated with the Vendor.
             Show Vendor Name and User Name at the top of the screen -->

        <div class="row no-gutters vend-client-user ">
            <div class="col-6 mb-0">
                <p class="nav-c-v-name m-0">{{ vendordetails.vend_name }}
            </div>
            <div class="col-6">
                <p class="nav-c-v-user m-0">Welcome, {{ userdetails.user_first_name }}!</p>
            </div>
        </div>

        {% else %}

        <!-- User is logged in and is associated with the client.
             Show client Name and User Name at the top of the screen -->

        <div class="row no-gutters vend-client-user ">
            <div class="col-6">
                <p class="nav-c-v-name m-0">{{ clientdetails.client_name }}
            </div>
            <div class="col-6">
                <p class="nav-c-v-user m-0">Welcome, {{ userdetails.user_first_name }}!</p>
            </div>
        </div>
        {% endif %} {% else %}

        <!-- No user logged in yet - leave a blank row where vendor / client 
             name and user name will be shown-->

        <div class="row no-gutters vend-client-user">

        </div>

        {% endif %}

        <!-- Show the navigation bar -->

        <nav class="navbar navbar-expand-lg navbar-light navbar-style nav-links">
            <div class="nav-logo">
                <a class="navbar-brand logo" href="{% url 'home' %}"></a>
            </div>

            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse  navbar-padding" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto ">
                    <li class="nav-item"><a class="nav-link" href="{% url 'home' %}"><i id="home" class="fa fa-home home-icon" aria-hidden="true"></i></a></li>

                    <!-- Show relevant links depending on whether the user is logged in or not -->

                    {% if user.is_authenticated %}

                    <li class="nav-item"><a class="nav-link" href="{% url 'profile' %}">Profile</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'logout' %}">Logout</a></li>
                    <li class="nav-item nav-issues-align"><a class=" btn iss-btn-color iss-button-font iss-nav-link iss-enabled-link" href="{% url 'user_home' %}"><i class="fas fa-list pr-1"></i>ISSUES</a></li>

                    {%if userdetails.user_type == "C" %}

                    <!-- Only Client-side users can enter issues -->

                    <li class="nav-item iss-ftr-ml"><a class="btn iss-btn-color iss-button-font iss-nav-link iss-enabled-link" href="{% url 'new_issue' %}"><i class="fas fa-plus pr-1"></i>ISSUE</a></li>

                    {% else %}

                    <!-- Else vendor-side user, Disable the new issue link -->

                    <li class="nav-item iss-ftr-ml"><span class="btn iss-btn-color iss-button-font iss-nav-link disabled-link"><i class="fas fa-plus pr-1"></i>ISSUE</span></li>
                    </li>
                    {% endif %}

                    <li class="nav-item iss-ftr-gap"><a class=" btn ftr-btn-color ftr-button-font ftr-nav-link ftr-enabled-link" href="{% url 'features_home' %}" data-value="MY FEATURES"><i class="fas fa-list pr-1"></i>FEATURES</a></li>

                    <!-- Only Client-side users can enter new features -->

                    {% if userdetails.user_type == "C" %}

                    <li class="nav-item iss-ftr-ml"><a href="{% url 'new_feature' %}" class="btn ftr-btn-color ftr-button-font ftr-nav-link ftr-enabled-link" data-value="ADD FEATURE"><i class="fas fa-plus pr-1"></i>FEATURE</a> {% else %}

                        <!-- Else, vendor-side user, disable the new features link -->

                        <li class="nav-item iss-ftr-ml"><span class="btn ftr-btn-color ftr-button-font ftr-nav-link disabled-link" data-value="ADD FEATURE"><i class="fas fa-plus pr-1"></i>FEATURE</span></li>


                        {% endif %}

                        <!-- Enable shopping cart link if user is on the client-side 
                             and there is something in the cart -->

                        <li class="cart-container">

                            {% if userdetails.user_type == "C" and feature_count > 0 %}


                            <!-- Enable the cart link -->

                            <a class="cart-button-font cart-nav-link cart-enabled-link" href="{% url 'view_cart' %}"><i class="fas fa-shopping-cart"></i> Cart
                                        
                        <!-- This will show how many features are in the cart -->
                                            
                        <label id="feature_count" class="badge cart-count-style">{{ feature_count }}</label></a> {% else %}

                            <!--Either the user is on the vendor side or there's nothing in the cart.
                            Show cart link disabled - 'disabled-link' has 'pointer-events:none' 
                             I need to keep the link because this element will be enabled / disabled by js also. -->

                            <a class="cart-color cart-button-font cart-nav-link disabled-link" href="{% url 'view_cart' %}"><i class="fas fa-shopping-cart"></i> Cart
                                        
                        <!-- Keep the label element, but show blank. The 'feature_count' id is used by js. -->
                                        
                        <label id="feature_count" class="badge cart-count-style"></label></a> {% endif %}


                        </li>

                        {% else %}
                        <!-- User is not logged in -->

                        <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Login</a></li>
                        <li class="nav-item"><a class="nav-link" href="{% url 'registration' %}">Register</a></li>
                        {% endif %}

                </ul>
            </div>
        </nav>
    </header>

    <section class="pg-bg">

        <!-- A line is kept just below the navbar to display messages -->

        <div class="row no-gutters">
            <div class="col-12 offset-lg-2 col-lg-8 p-0">

                <ul class="mesg-style p-0  text-center">
                    {% if messages %} {% for message in messages %}
                    <li class="user-message">{{ message }}</li>
                    {% endfor%} {% else %}
                    <li class="user-message blank-line">blank</li>
                    {% endif %}
                </ul>
            </div>
        </div>

        {% block content %}{% endblock %}

    </section>



    <!-- Pagination 
         This is used by both the issues list and the features list.
         Both issues and features are passed back in 'listing' so that the
         pagination variables will be picked up 
         Specific classes prefixed with 'iss- are added for issue; and classes
         prefixed with 'ftr-' are added for features. This is because the 
         highlighter color is different for each  -->

    <nav id="paginate" class="pag-nav-section" aria-label="Page navigation">
        {% if listing.has_other_pages %}

        <ul class="pagination justify-content-center mt-3">

            {% if listing.has_previous %}

            <!-- Add the correct classes depending on whether its the issue list ('iss-') or the 
                     features list ('ftr-')  -->

            {% if list_type == "issues" %}

            <!-- if the issues list was generated from the search box, the search parameter must be passed back as well -->

            {% if searching == 'y' %}

            <li class="page-item"><a class="page-link iss-page-live-link" href="?page={{ listing.previous_page_number }}/?q_issues={{ search_value }}">&laquo;</a></li>
            {% else %}
            <li class="page-item"><a class="page-link iss-page-live-link" href="?page={{ listing.previous_page_number }}">&laquo;</a></li>
            {% endif %} {% else %}

            <!-- Features list: If the list was generated via the search box, the search value must be passed back as well -->

            {% if searching == 'y' %}
            <li class="page-item"><a class="page-link ftr-page-live-link" href="?page={{ listing.previous_page_number }}/?q_issues={{ search_value }}">&laquo;</a></li>
            {% else %}
            <li class="page-item"><a class="page-link ftr-page-live-link" href="?page={{ listing.previous_page_number }}">&laquo;</a></li>
            {% endif %} {% endif %} {% else %}

            <li class="page-item"><span class="page-link">&laquo;</span></li>

            {% endif %}

            <!-- Output the other page numbers -->

            {% for i in listing.paginator.page_range %} {% if listing.number == i %}

            <!-- Add the correct classes depending on whether its the issue list ('iss-') or the 
                         features list ('ftr-')  -->

            {% if list_type == "issues" %}

            <li class="page-item"><span class="page-link iss-selected">{{ i }} <span class="sr-only">(current)</span></span>
            </li>

            {% else %}

            <li class="page-item"><span class="page-link ftr-selected">{{ i }} <span class="sr-only">(current)</span></span>
            </li>

            {% endif %} {% else %}

            <!-- Add the correct classes depending on whether its the issue list ('iss-') or the 
                             features list ('ftr-')  -->

            {% if list_type == "issues" %}

            <!-- If listing was generated from search box, pass back the search value as well -->

            {% if searching == 'y' %}

            <!-- Searching-->

            <li class="page-item"><a class="page-link iss-page-live-link" href="?page={{ i }}/?q_issues={{ search_value }}">{{ i }}</a></li>

            {% else %}
            <!-- Not Searching-->
            <li class="page-item"><a class="page-link iss-page-live-link" href="?page={{ i }}">{{ i }}</a></li>
            {% endif %} {% else %}

            <!-- Features list: If listing was generated from search box, pass back the search value as well -->

            {% if searching == 'y' %}

            <li class="page-item"><a class="page-link ftr-page-live-link" href="?page={{ i }}/?q_issues={{ search_value }}">{{ i }}</a></li>
            {% else %}

            <li class="page-item"><a class="page-link ftr-page-live-link" href="?page={{ i }}">{{ i }}</a></li>
            {% endif %} {% endif %} {% endif %} {% endfor %} {% if listing.has_next %}

            <!-- Add the correct classes depending on whether its the issue list ('iss-') or the 
                     features list ('ftr-')  -->

            {% if list_type == "issues" %}

            <li class="page-item"><a class="page-link iss-page-live-link" href="?page={{ listing.next_page_number }}">&raquo;</a></li>

            {% else %}

            <li class="page-item"><a class="page-link ftr-page-live-link" href="?page={{ listing.next_page_number }}">&raquo;</a></li>

            {% endif %} {% else %}

            <li class="page-item"><span class="page-link">&raquo;</span></li>
            {% endif %}

        </ul>
        {% endif %}
    </nav>


    <footer>
    </footer>



    <!-- Custom Javascript -->



    <script>
        // The following script manages the Filtering and Pagination of Issues 
        // and Features when selections are made from the dropdown filters


        $(document).ready(function() {

            // ISSUES PROCESSING -------------------------------------------//

            // ===========================
            // Filtering by Issue Filter 
            // ===========================

            // A value has been selected by the user from the Issues Filter 
            // dropdown 

            $('.issue-filter').on('click', function() {

                event.preventDefault();
                let issuesFilter = $(this).data('value');

                console.log("issuesFilter : " + issuesFilter)

                // Clear the contents of the search box, to avoid confusing the user

                document.getElementById('iss-search-val').value = ""

                // Change the value showing in the dropdown box to the new 
                // value selected by the user

                $('#dropdownMenuLink-1').text(issuesFilter);

                // When the user selects a value from the Issues Filter, all the
                // other filters are reset to "ALL"

                // Reset Status Filter to "ALL" and display it in the filter
                // dropdown box

                let statusFilter = "ALL"
                $('#dropdownMenuLink-2').text(statusFilter);

                // Reset Priority Filter to "ALL" and display it in the filter
                // dropdown box

                let priorityFilter = "ALL"
                $('#dropdownMenuLink-3').text(priorityFilter);

                // Reset Client Filter to "ALL". If this is a client-side 
                // user, the Client Code dropdown option wont be displayed on
                // screen. If its a vendor-side user, display "ALL" in the 
                // Client dropdown box

                let clientFilter = "ALL";

                if ($("#dropdownMenuLink-4").length > 0) {

                    $('#dropdownMenuLink-4').text(clientFilter);
                }

                // Get the issues requested by the user, as per the filter
                // values, starting with page 1

                // Clear searchValue - it is only set when the user inputs a 
                // value in the search box

                let searchValue = ""

                // Initialise the page number

                let page = 1;

                getIssues(issuesFilter, statusFilter, priorityFilter, clientFilter, page, searchValue);

            });


            // ===========================
            // Filtering Issues by Status Filter
            // ===========================

            // A value has been selected from the Status filter dropdown by the user

            $('.iss-status-filter').on('click', function() {

                event.preventDefault();
                let statusFilter = $(this).data('value');

                // Clear the contents of the search box, to avoid confusing the user

                document.getElementById('iss-search-val').value = ""


                // Change the value showing in the dropdown box to the new 
                // value selected by the user

                $('#dropdownMenuLink-2').text(statusFilter);

                // When the status filter is selected, it will be used in
                // conjunction with the current values of the other 2 filters

                // Get the current value of the Issues Filter
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let issuesFilter = getIssuesFilterValue();

                if (issuesFilter == "") {
                    issuesFilter = 'ALL ISSUES'
                    $('#dropdownMenuLink-1').text(issuesFilter);
                }

                // Get the current value of the Priority Filter
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let priorityFilter = getPriorityFilterValue();

                console.log("priorityFilter: " + priorityFilter)

                if (priorityFilter == "") {
                    priorityFilter = 'ALL'
                    console.log("setting priorityFilter to ALL")
                    $('#dropdownMenuLink-3').text(priorityFilter);
                }

                // Get the current value of the Client Filter, if it's an
                // option on the screen, otherwise set it to "ALL"
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let clientFilter = getClientFilterValue();

                if (clientFilter == "") {
                    clientFilter = 'ALL'
                    $('#dropdownMenuLink-4').text(clientFilter);
                }

                // Clear searchValue - it is only set when the user inputs a 
                // value in the search box

                let searchValue = ""

                // Initialise the page number

                let page = 1;

                console.log("in status filter click")
                console.log("statusFilter: " + statusFilter);
                console.log("issuesFilter: " + issuesFilter);
                console.log("priorityFilter: " + priorityFilter);
                console.log("clientFilter: " + clientFilter);

                getIssues(issuesFilter, statusFilter, priorityFilter, clientFilter, page, searchValue);
            });


            // ===========================
            // Filtering Issues by Priority
            // ===========================

            $('.priority-filter').on('click', function() {

                event.preventDefault();

                let priorityFilter = $(this).data('value');
                let priorityFilterText = this.innerText;

                // Clear the contents of the search box, to avoid confusing the user

                document.getElementById('iss-search-val').value = ""


                // A value has been selected from the Priority Filter dropdown 
                // by the user

                // Change the value showing in the dropdown box to the new 
                // value selected by the user

                $('#dropdownMenuLink-3').text(priorityFilterText);

                // When the priority filter is selected, it will be used in
                // conjunction with the current values of the other 2 filters

                // Get the current value of the Issues Filter
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let issuesFilter = getIssuesFilterValue();

                if (issuesFilter == "") {
                    issuesFilter = 'ALL ISSUES'
                    $('#dropdownMenuLink-1').text(issuesFilter);
                }


                // Get the current value of the Status Filter
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let statusFilter = getStatusFilterValue();

                if (statusFilter == "") {
                    statusFilter = 'ALL'
                    $('#dropdownMenuLink-2').text(statusFilter);
                }


                // Get the current value of the Client Filter, if it's an
                // option on the screen, otherwise set it to "ALL"
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let clientFilter = getClientFilterValue();

                if (clientFilter == "") {
                    clientFilter = "ALL"
                    $('#dropdownMenuLink-4').text(clientFilter);
                }

                // Clear searchValue - it is only set when the user inputs a 
                // value in the search box

                let searchValue = ""

                // Initialise the page number

                let page = 1;

                getIssues(issuesFilter, statusFilter, priorityFilter, clientFilter, page, searchValue);
            });


            // ===========================
            // Filtering Issues by Client Filter 
            // ===========================

            // Client Filter has been selected by the user. The Client Filter
            // will only be available when the user is a vendor-side user

            $('.iss-client-filter').on('click', function() {

                event.preventDefault();
                let clientFilter = $(this).data('value');

                // Clear the contents of the search box, to avoid confusing the user

                document.getElementById('iss-search-val').value = "";

                // A value has been selected from the Client Filter dropdown by
                // the user

                // Change the value showing in the dropdown box to the new 
                // value selected by the user

                $('#dropdownMenuLink-4').text(clientFilter);

                // When the client filter is selected, it will be used in
                // conjunction with the current values of the other 2 filters

                // Get the current value of the Issues Filter
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let issuesFilter = getIssuesFilterValue();

                if (issuesFilter == "") {
                    issuesFilter = 'ALL ISSUES'
                    $('#dropdownMenuLink-1').text(issuesFilter);
                }


                // Get the current value of the Status Filter
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let statusFilter = getStatusFilterValue();

                if (statusFilter == "") {
                    statusFilter = 'ALL'
                    $('#dropdownMenuLink-2').text(statusFilter);
                }


                // Get the current value of the Priority Filter
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let priorityFilter = getPriorityFilterValue();

                if (priorityFilter == "") {
                    priorityFilter = 'ALL'
                    $('#dropdownMenuLink-3').text(priorityFilter);
                }


                // Clear searchValue - it is only set when the user inputs a 
                // value in the search box

                let searchValue = "";

                // Initialise the page number

                let page = 1;

                getIssues(issuesFilter, statusFilter, priorityFilter, clientFilter, page, searchValue);
            });


            //==================================================================
            // SEARCH BOX - Searching for Issues where text in the Issue Summary
            // matches the text input in the input box
            //==================================================================

            $('#iss-search-btn').on('click', function() {

                // The user has input a value in the Issues search box 

                event.preventDefault();

                let searchValue = document.getElementById('iss-search-val').value

                console.log("searchValue : " + searchValue);

                // When the user enters a value in the search box, all the filters
                // will be set to spaces, as only the search value will be used
                // to select the issues

                let issuesFilter = ""
                $('#dropdownMenuLink-1').text(issuesFilter);
                let statusFilter = ""
                $('#dropdownMenuLink-2').text(statusFilter);
                let priorityFilter = ""
                $('#dropdownMenuLink-3').text(priorityFilter);
                let clientFilter = "";
                $('#dropdownMenuLink-4').text(clientFilter);

                // Get the issues requested by the user, as per the filter
                // values, starting with page 1

                let page = 1;

                getIssues(issuesFilter, statusFilter, priorityFilter, clientFilter, page, searchValue);

            });


            // ===========================
            // Issues Pagination
            // ===========================

            // The user has clicked on a page number
            // Using "$(document).on . . ." here because the 'iss-page-click' 
            // class is not part of the html when it is first loaded, they are
            // added by js when it displays the filtered data, and therefore the
            // js wont respond to "$('.iss-page-click').on('click', function()"

            $(document).on('click', ".iss-page-click", function() {

                // Get the page number the user clicked on

                var page = $(this).data('value');

                console.log("in iss-page-click");

                console.log("this page: " + page);

                // Get the current values of the filters

                let issuesFilter = getIssuesFilterValue();
                let statusFilter = getStatusFilterValue();
                let priorityFilter = getPriorityFilterValue();
                let clientFilter = getClientFilterValue();
                let searchValue = document.getElementById('iss-search-val').value

                console.log("priorityFilter: " + priorityFilter);

                // Get the issues as per the filter values and page number

                getIssues(issuesFilter, statusFilter, priorityFilter, clientFilter, page, searchValue);
            });


            // ================
            // HELPER FUNCTIONS
            // ================
            // Get the current value of the issues filter

            function getIssuesFilterValue() {

                // Get the current value of the Issues Filter

                let el = document.getElementById("dropdownMenuLink-1");
                let issuesFilter = el.innerText;

                return issuesFilter;

            }

            // Get the current value of the Status Filter

            function getStatusFilterValue() {

                let el = document.getElementById("dropdownMenuLink-2");

                let statusFilter = el.innerText;

                return statusFilter;

            }

            // Get the current value of the Priority Filter
            // The priority in the db is just a number from 1 - 5. But on the 
            // screen a descriptive text is included, e.g. 1 - URGENT. When
            // getting the value of the current priority filter, the '1' must
            // be extracted from the text.

            function getPriorityFilterValue() {

                let el = document.getElementById("dropdownMenuLink-3");
                let priorityFilter = el.innerText

                if (el.innerText != "ALL" & el.innerText != "") {

                    let priorityArray = el.innerText.split("");
                    console.log("in getPriorityFilterValue.  priorityArray[0,0]: " + priorityArray[0, 0])
                    priorityFilter = priorityArray[0, 0];
                }

                console.log("in getPriorityFilterValue. priorityFilter: " + priorityFilter)

                return priorityFilter;

            }


            // Get the current value of the Client Filter, if it's an
            // option on the screen, otherwise set it to "ALL"

            function getClientFilterValue() {

                let clientFilter = "ALL";

                if ($("#dropdownMenuLink-4").length > 0) {

                    let el = document.getElementById("dropdownMenuLink-4");

                    clientFilter = el.innerText;
                }

                return clientFilter;

            }


            // =================================
            // Get the issues from the database 
            // =================================

            // Get the relevant issues, based on the value of the filters


            function getIssues(issuesFilter, statusFilter, priorityFilter, clientFilter, page, searchValue) {

                console.log("in getIssues(). page = " + page)
                console.log("searchValue: " + searchValue)

                $.post({
                    url: "{% url 'get_issues' %}",
                    data: {
                        csrfmiddlewaretoken: "{{csrf_token}}",
                        issuesFilter: issuesFilter,
                        statusFilter: statusFilter,
                        priorityFilter: priorityFilter,
                        clientFilter: clientFilter,
                        page: page,
                        searchValue: searchValue,

                    },

                    success: function(data) {


                        // Display user message if one is returned
                        // If the message is blank, keep the line, but make
                        // it invisible on the screen

                        var userMessage = data.user_mesg.user_message;

                        if (userMessage != "") {
                            console.log("userMessage: " + userMessage)
                            $('.user-message').text(userMessage)
                            $('.user-message').removeClass('blank-line')
                        }
                        else {
                            $('.user-message').text("blank")
                            $('.user-message').addClass('blank-line')
                        }


                        // Clear the current contents of the table
                        // Output the details of each issue to the table 

                        $("tbody").empty();
                        $.each(data.issues, function(key, value) {

                            var issueId = value.id;

                            var inputDate = value.date;
                            var user = value.user;

                            // Initialise 'linkEnabledDisabled'. Class To be 
                            // added to thumbs up to enable / disable

                            var linkEnabledDisabled = "";


                            if (value.user_type == "C") {
                                var assignedUser = value.assigned_client_user;
                                linkEnabledDisabled = " iss-enabled-link"
                            }
                            else {
                                var assignedUser = value.assigned_vendor_user;
                                linkEnabledDisabled = " disabled-link"
                            }

                            var softwareComponent = value.software_component;
                            var priority = value.priority;
                            var summary = value.summary;
                            var status = value.status;
                            var issueThumbsUp = value.thumbs_up

                            // Output the Issue Details to the table, including the 'more' icon in the last cell

                            $("tbody").append(
                                "<tr><td class='td-id'>" + issueId + "</td><td class='td-date'>" + inputDate + "</td><td class='td-username'>" + user + "</td><td class='td-username'>" + assignedUser + "</td><td class='td-sw-comp'>" + softwareComponent + "</td><td class='text-center td-priority'>" + priority + "</td><td class='td-summary'>" + summary + "</td><td class='text-center td-status'>" + status + "</td><td class='pl-0 ml-0  td-thumbs-up'><a href = '#' class='" + issueId + " btn iss-td-thumbs-up-style td-form-font iss-thumbs-up-click" + linkEnabledDisabled + "'><i class='fas fa-thumbs-up thumbs-up-icon'"+"></i></a>"+"</td><td class='text-center td-thumbs-up'>" + issueThumbsUp + "</td><td class='text-center td-more'><a class='iss-more-icon-style' href=/issue_tracker/" + issueId + "-n" + "/ " + "><i class='fas fa-ellipsis-h more-icon-style'></i></a></td></tr>"
                            );
                            
                            

                            console.log("input date: " + inputDate + " user:  " + user + " summary: " + summary);

                        });


                        // Output the pagination parameters for the issues list to the html page

                        let listType = "issues"
                        outputPaginationValues(data, listType)

                    },
                    traditional: true
                }).done();
            }

            /* ================================================================
               THE FOLLOWING FUNCTIONS MANAGE THE ISSUES COMMENTS SHOW / HIDE 
               ================================================================
               
                The following functions manage the Issue Comments show /hide
            */

            $('#enable-comments').on('click', function() {

                // Enable Comments icon clicked:
                // Show the dashboard, but keep the comments form hidden.
                // The comments form will be enabled by the '+' on the dashboard

                $('#iss-comments-form').hide();

                $('.iss-comments-dash').removeClass('d-none').hide();
                $('.iss-comments-dash').slideDown(500);

                // Disable the 'enable comments' icon 

                $('#enable-comments').removeClass('iss-enabled-link');
                $('#enable-comments').addClass('disabled-link');

                // Enable the 'disable comments' icon 

                $('#disable-comments').removeClass('disabled-link');
                $('#disable-comments').addClass('iss-enabled-link');


                // Enable the '+' icon - to open form and add comments

                $('#iss-comments-plus').addClass('iss-enabled-link');
                $('#iss-comments-plus').removeClass('disabled-link');

                // Disable the '-' icon - this closes the form once its open

                $('#iss-comments-minus').removeClass('iss-enabled-link');
                $('#iss-comments-minus').addClass('disabled-link');

                // Enable the 'open comments list view' icon 

                $('#iss-comments-open').removeClass('disabled-link');
                $('#iss-comments-open').addClass('iss-enabled-link');

                // Disable the 'close comments list view' icon 

                $('#iss-comments-close').removeClass('iss-enabled-link');
                $('#iss-comments-close').addClass('disabled-link');

                console.log("Comments enabled.........................")
            });


            $('#disable-comments').on('click', function() {

                // Disable Comments icon clicked:
                // Hide the comments dashboard, form, and list 

                $('.iss-comments-dash').slideUp();
                $('#iss-comments-form').slideUp();
                $('#iss-comments-list').slideUp();

                // Enable the 'enable comments' icon 

                $('#enable-comments').removeClass('disabled-link');
                $('#enable-comments').addClass('iss-enabled-link');

                // Disable the 'disable comments' icon 

                $('#disable-comments').removeClass('iss-enabled-link');
                $('#disable-comments').addClass('disabled-link');


                console.log("Comments disabled.........................")
            });


            $('#iss-comments-plus').on('click', function() {

                // The '+' on the comments dashboard has been clicked:
                // Show the comments input form

                $('#iss-comments-form').removeClass('d-none').hide();
                $('#iss-comments-form').slideDown(500);

                // Disable the '+'

                $('#iss-comments-plus').removeClass('iss-enabled-link');
                $('#iss-comments-plus').addClass('disabled-link');

                // Enable the '-'

                $('#iss-comments-minus').addClass('iss-enabled-link');
                $('#iss-comments-minus').removeClass('disabled-link');


                // Close the comments list view, in case it's open

                $('#iss-comments-list').slideUp(500);

                // Disable the 'close comments list view' icon

                $('#iss-comments-close').removeClass('iss-enabled-link');
                $('#iss-comments-close').addClass('disabled-link');

                // Enable the 'open comments list view' icon

                $('#iss-comments-open').addClass('iss-enabled-link');
                $('#iss-comments-open').removeClass('disabled-link');
            });


            $('#iss-comments-minus').on('click', function() {

                // The '-' on the comments dashboard has been clicked:
                // Hide the comments input form

                $('#iss-comments-form').slideUp(500);

                // Disable the '-'

                $('#iss-comments-minus').removeClass('iss-enabled-link');
                $('#iss-comments-minus').addClass('disabled-link');

                // Enable the '+'

                $('#iss-comments-plus').addClass('iss-enabled-link');
                $('#iss-comments-plus').removeClass('disabled-link');
            });


            $('#iss-comments-open').on('click', function() {

                // The view comments list icon on the comments dashboard has been 
                // clicked:
                // Show the comments list

                // First, close the comments input form, in case it's open

                $('#iss-comments-form').slideUp(500);

                // Disable the '-'

                $('#iss-comments-minus').removeClass('iss-enabled-link');
                $('#iss-comments-minus').addClass('disabled-link');

                // Enable the '-'

                $('#iss-comments-plus').addClass('iss-enabled-link');
                $('#iss-comments-plus').removeClass('disabled-link');

                // Show the comments list view

                $('#iss-comments-list').removeClass('d-none').hide();
                $('#iss-comments-list').slideDown(500);

                // Disable the 'open comments list view' icon

                $('#iss-comments-open').removeClass('iss-enabled-link');
                $('#iss-comments-open').addClass('disabled-link');

                // Enable the 'close comments list view' icon

                $('#iss-comments-close').addClass('iss-enabled-link');
                $('#iss-comments-close').removeClass('disabled-link');
            });


            $('#iss-comments-close').on('click', function() {

                // The 'close comments list view' on the comments dashboard has been clicked:
                // Hide the comments list

                $('#iss-comments-list').slideUp(500);

                // Disable the 'close comments list view' icon

                $('#iss-comments-close').removeClass('iss-enabled-link');
                $('#iss-comments-close').addClass('disabled-link');

                // Enable the 'open comments list view' icon

                $('#iss-comments-open').addClass('iss-enabled-link');
                $('#iss-comments-open').removeClass('disabled-link');

            });


            /* ==============================================================
               FEATURES PROCESSING 
               ==============================================================
               
               The following function manage the filtering of features by 
               Features Filter, Status Filter, Paid Filter, and Client Filter 
               (vendor-side users only)
            */


            // Filtering by Features Filter

            $('.features-filter').on('click', function() {

                // A value has been selected from the  Features Filter dropdown 
                // by the user

                event.preventDefault();
                let featuresFilter = $(this).data('value');

                // Clear the contents of the search box, to avoid confusing the user

                document.getElementById('ftr-search-val').value = ""

                console.log("featuresFilter : " + featuresFilter)

                // The user has selected a value from the Features Filter dropdown

                // Change the value showing in the dropdown box to the new 
                // value selected by the user

                $('#dropdownMenuLink-1').text(featuresFilter);

                // When the user selects a value from the Features Filter, all the
                // other filters are reset to "ALL"

                // Reset Status Filter to "ALL" and display it in the filter
                // dropdown box

                let statusFilter = "ALL"
                $('#dropdownMenuLink-2').text(statusFilter);

                // Reset Paid Filter to "ALL" and display it in the filter
                // dropdown box

                let paidFilter = "ALL"
                $('#dropdownMenuLink-3').text(paidFilter);

                // Reset Client Filter to "ALL". If this is a client-side 
                // user, the Client Code dropdown option wont be displayed on
                // screen. If its a vendor-side user, display "ALL" in the 
                // Client dropdown box

                let clientFilter = "ALL";

                if ($("#dropdownMenuLink-4").length > 0) {

                    $('#dropdownMenuLink-4').text(clientFilter);
                }

                // Clear searchValue - it is only set when the user inputs a 
                // value in the search box

                let searchValue = ""

                // Get the features requested by the user, as per the filter
                // values, starting with page 1

                let page = 1;

                console.log("about to call getFeatures")

                getFeatures(featuresFilter, statusFilter, paidFilter, clientFilter, page, searchValue);

            });



            // Filtering by Status Filter

            $('.feat-status-filter').on('click', function() {

                // Status filter has been selected by the user

                event.preventDefault();
                let statusFilter = $(this).data('value');

                // Clear the contents of the search box, to avoid confusing the user

                document.getElementById('ftr-search-val').value = ""

                // The user has selected a value from the Status Filter dropdown
                // Change the value showing in the dropdown box to the new 
                // value selected by the user

                $('#dropdownMenuLink-2').text(statusFilter);

                // When the status filter is selected, it will be used in
                // conjunction with the current values of the other 2 filters

                // Get the current value of the Features Filter
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let featuresFilter = getFeaturesFilterValue();

                if (featuresFilter == "") {
                    featuresFilter = 'ALL FEATURES'
                    $('#dropdownMenuLink-1').text(featuresFilter);
                }

                // Get the current value of the Paid Filter
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let paidFilter = getPaidFilterValue();

                if (paidFilter == "") {
                    paidFilter = 'ALL'
                    $('#dropdownMenuLink-3').text(paidFilter);
                }

                // Get the current value of the Client Filter, if it's an
                // option on the screen, otherwise set it to "ALL"
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let clientFilter = getClientFilterValue();

                if (clientFilter == "") {
                    clientFilter = 'ALL'
                    $('#dropdownMenuLink-4').text(clientFilter);
                }

                // Clear searchValue - it is only set when the user inputs a 
                // value in the search box

                let searchValue = ""

                // Get the features requested by the user, as per the filter
                // values, starting with page 1

                let page = 1;

                console.log("in status filter click")
                console.log("statusFilter: " + statusFilter);
                console.log("featuresFilter: " + featuresFilter);
                console.log("paidFilter: " + paidFilter);
                console.log("clientFilter: " + clientFilter);

                getFeatures(featuresFilter, statusFilter, paidFilter, clientFilter, page, searchValue);
            });


            // Filtering by Paid


            $('.paid-filter').on('click', function() {

                // Paid filter has been selected by the user

                event.preventDefault();

                let paidFilter = $(this).data('value');
                let paidFilterText = this.innerText;

                // Clear the contents of the search box, to avoid confusing the user

                document.getElementById('ftr-search-val').value = ""

                // The user has selected a value from the Paid Filter dropdown

                // Change the value showing in the dropdown box to the new 
                // value selected by the user

                $('#dropdownMenuLink-3').text(paidFilterText);

                // When the priority filter is selected, it will be used in
                // conjunction with the current values of the other 2 filters

                // Get the current value of the Features Filter
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let featuresFilter = getFeaturesFilterValue();

                if (featuresFilter == "") {
                    featuresFilter = 'ALL FEATURES'
                    $('#dropdownMenuLink-1').text(featuresFilter);
                }

                // Get the current value of the Status Filter
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let statusFilter = getStatusFilterValue();

                if (statusFilter == "") {
                    statusFilter = 'ALL'
                    $('#dropdownMenuLink-2').text(statusFilter);
                }


                // Get the current value of the Client Filter, if it's an
                // option on the screen, otherwise set it to "ALL"
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let clientFilter = getClientFilterValue();

                if (clientFilter == "") {
                    clientFilter = 'ALL'
                    $('#dropdownMenuLink-4').text(clientFilter);
                }

                // Clear searchValue - it is only set when the user inputs a 
                // value in the search box

                let searchValue = ""

                // Get the features requested by the user, as per the filter
                // values, starting with page 1

                let page = 1;

                getFeatures(featuresFilter, statusFilter, paidFilter, clientFilter, page, searchValue);
            });


            // Filtering by Client Filter 

            $('.feat-client-filter').on('click', function() {

                // Client Filter has been selected by the user. The Client Filter
                // will only be available when the user is a vendor-side user

                console.log("in .feat-client-filter-------------------")

                event.preventDefault();
                let clientFilter = $(this).data('value');

                // Clear the contents of the search box, to avoid confusing the user

                document.getElementById('ftr-search-val').value = ""

                // The user has selected a value from the Client Filter dropdown

                // Change the value showing in the dropdown box to the new 
                // value selected by the user

                $('#dropdownMenuLink-4').text(clientFilter);

                // When the client filter is selected, it will be used in
                // conjunction with the current values of the other 2 filters

                // Get the current value of the Features Filter
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let featuresFilter = getFeaturesFilterValue();

                if (featuresFilter == "") {
                    featuresFilter = 'ALL FEATURES'
                    $('#dropdownMenuLink-1').text(featuresFilter);
                }

                // Get the current value of the Status Filter
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let statusFilter = getStatusFilterValue();

                console.log("current value of status filter; " + statusFilter)

                if (statusFilter == "") {
                    console.log("statusfilter blank: " + statusFilter)
                    statusFilter = 'ALL';
                    $('#dropdownMenuLink-2').text(statusFilter);
                }

                console.log("1. statusFilter = " + statusFilter)
                // Get the current value of the Priority Filter
                // It may be blank if the user was previously using the search
                // box - if so, set it to 'ALL'

                let paidFilter = getPaidFilterValue();
                console.log("2. statusFilter = " + statusFilter)

                if (paidFilter == "") {
                    paidFilter = 'ALL';
                    $('#dropdownMenuLink-3').text(paidFilter);
                }
                console.log("3. statusFilter = " + statusFilter)

                // Clear searchValue - it is only set when the user inputs a 
                // value in the search box

                let searchValue = "";

                // Get the features requested by the user, as per the filter
                // values, starting with page 1

                let page = 1;

                console.log("before getFeatures, statusFilter: " + statusFilter)

                getFeatures(featuresFilter, statusFilter, paidFilter, clientFilter, page, searchValue);
            });


            // Search Box - search the Feature Summary for the value the user has input

            $('#ftr-search-btn').on('click', function() {

                // The user has input a value in the Issues search box 

                event.preventDefault();

                let searchValue = document.getElementById('ftr-search-val').value

                console.log("features searchValue : " + searchValue);

                // When the user enters a value in the search box, all the filters
                // will be set to spaces, as only the search value will be used
                // to select the features

                let featuresFilter = ""
                $('#dropdownMenuLink-1').text(featuresFilter);
                let statusFilter = ""
                $('#dropdownMenuLink-2').text(statusFilter);
                let paidFilter = ""
                $('#dropdownMenuLink-3').text(paidFilter);
                let clientFilter = "";
                $('#dropdownMenuLink-4').text(clientFilter);

                // Get the features requested by the user, as per the filter
                // values, starting with page 1

                let page = 1;

                getFeatures(featuresFilter, statusFilter, paidFilter, clientFilter, page, searchValue);

            });



            // Features Pagination

            $(document).on('click', ".feat-page-click", function() {

                    // The user has clicked on a page number
                    // Using "$(document).on . . ." here because the 'feat-page-click' 
                    // class is not part of the html when it is first loaded, they are
                    // added by js when it displays the filtered data, and therefore the
                    // js wont respond to "$('.iss-page-click').on('click', function()"

                    // Get the page number the user clicked on

                    var page = $(this).data('value');

                    console.log("in feat-page-click");

                    console.log("this page: " + page);

                    // Get the current values of the filters and the search box

                    let featuresFilter = getFeaturesFilterValue();
                    let statusFilter = getStatusFilterValue();
                    let paidFilter = getPaidFilterValue();
                    let clientFilter = getClientFilterValue();
                    let searchValue = document.getElementById('ftr-search-val').value

                    console.log("paidFilter: " + paidFilter);

                    // Get the features as per the filter values and page number

                    getFeatures(featuresFilter, statusFilter, paidFilter, clientFilter, page, searchValue);
                }

            );


            // User wants to add a quantity of a specific feature to the cart

            $(document).on('click', ".ftr-thumbs-up-click", function() {

                // Extract the button element just clicked on, and separate the
                // classes into an array. The featureId is the first class
                // e.g. the button element is created like this:
                // <button class='" + featureId + " btn td-thumbs-up-style td-form-font td-add ftr-thumbs-up-click' type='submit'>
                // So if the feature id = '16', 'classes' below will be = "16 btn td-thumbs-up-style td-form-font td-add ftr-thumbs-up-click", 
                // where 'i6' is the id of the feature relevant to the Add button just clicked. We want to get the featureId

                var classes = $(this).attr("class").split(" ");

                let featureId = classes[0];

                console.log("addFeatureId = " + featureId);

                // When the thumbs up button is clicked '1' will be added to the#
                // cart count

                var qty = 1;

                console.log("qty = " + qty);

                // Add the feature / qty to the cart

                $.post({
                    url: "{% url 'add_to_cart_js' %}",

                    data: {
                        csrfmiddlewaretoken: "{{csrf_token}}",
                        featureId: featureId,
                        qty: qty

                    },

                    success: function(data) {

                        // We need to update the quantity showing for the cart
                        // Get the current value showing in the cart and add the
                        // new quantity

                        console.log("current value in dom: " + parseInt(document.getElementById('feature_count').innerText));

                        var currentQty = parseInt(document.getElementById('feature_count').innerText);

                        // If there's nothing in the cart yet - set to zero and
                        // enable the cart link

                        if (isNaN(currentQty)) {
                            currentQty = 0
                            $('.cart-nav-link').removeClass('disabled-link')
                            $('.cart-nav-link').addClass('cart-enabled-link')
                        }

                        console.log("currentQty = " + currentQty);

                        var newQty = currentQty + parseInt(qty);

                        // Update the cart count

                        $('#feature_count').text(newQty);

                    }
                });

            });


            // ================
            // HELPER FUNCTIONS
            // ================

            // Get the current value of the Features Filter

            function getFeaturesFilterValue() {

                // Get the current value of the Features Filter

                let el = document.getElementById("dropdownMenuLink-1");
                let featuresFilter = el.innerText;

                return featuresFilter;

            }


            // Get the current value of the Paid Filter

            function getPaidFilterValue() {

                let el = document.getElementById("dropdownMenuLink-3");
                let paidFilter = el.innerText

                if (el.innerText != "ALL" & el.innerText != "") {

                    let paidArray = el.innerText.split("");
                    console.log("in getPaidFilterValue.  paidArray[0,0]: " + paidArray[0, 0])
                    paidFilter = paidArray[0, 0];
                }

                console.log("in getPaidFilterValue. paidFilter: " + paidFilter)

                return paidFilter;

            }


            // ====================
            // PAGINATION FUNCTION
            // ====================

            // Get the pagination parameters passed from 
            // views.get_features and output them to the html page,
            // so that the user can select the pages

            function outputPaginationValues(data, listType) {

                var has_other_pages = data.pagination_props.has_other_pages;
                var has_prev_page = data.pagination_props.has_prev_page;
                var current_page = data.pagination_props.current_page;
                var has_next_page = data.pagination_props.has_next_page;
                var prev_page_nr = data.pagination_props.prev_page_nr;
                var next_page_nr = data.pagination_props.next_page_nr;
                var page_range = data.pagination_props.page_range;

                // Clear the pagination nav, in case we only have one page

                $("#paginate").empty();

                // NOTE: The html elements weren't rendering correctly when I output the values straight
                // to the <ul> / <li> e.g. it was adding </ul> / </li> in places where I didnt want them. 
                // To get around the problem I output the html elements to a variable first, then output it
                // to the html element. This worked.

                if (has_other_pages) {

                    if (has_prev_page) {

                        if (listType == "issues") {

                            // Output the class 'iss-page-click' or 'feat-page-click', depending on whether the
                            // list being paginated is for Issues or Features, so that the correct js functions will be 
                            // triggered for each list
                            // Also Output the class 'iss-page-live-link' or 'ftr-page-live-link', depending on whether the
                            // list being paginated is for Issues or Features, so that they will be highlighted with the correct
                            // color or hover

                            var prevPageLink = "<ul class='pagination justify-content-center mt-3'><li class='page-item'><a class='page-link iss-page-live-link iss-page-click' href='#' data-value=" + prev_page_nr + " aria-label='Previous'>&laquo;</a></li>";
                        }
                        else {
                            prevPageLink = "<ul class='pagination justify-content-center mt-3'><li class='page-item'><a class='page-link ftr-page-live-link feat-page-click' href='#' data-value=" + prev_page_nr + " aria-label='Previous'>&laquo;</a></li>";
                        }
                    }

                    else {
                        prevPageLink = "<ul class='pagination justify-content-center mt-3'><li class='page-item'><span class='page-link' aria-label='Next'>&laquo;</span></li>";

                    }

                    // Output the pagination values to the html page

                    var pageLinks = "";
                    var i = 0;

                    for (i in page_range) {

                        if (current_page === page_range[i]) {

                            if (pageLinks == "") {

                                if (listType == "issues") {

                                    // Output the class 'iss-selected' or 'ftr-selected' depending on whether this is the
                                    // issues list or features list, so that the highlight color for each will be applied

                                    pageLinks = "<li class='page-item'><span class='page-link iss-selected'>" + page_range[i] + "<span class='sr-only'>(current)</span></span></li>";
                                }
                                else {
                                    pageLinks = "<li class='page-item'><span class='page-link ftr-selected'>" + page_range[i] + "<span class='sr-only'>(current)</span></span></li>";
                                }

                            }
                            else {

                                if (listType == "issues") {

                                    // Output the class 'iss-selected' or 'ftr-selected' depending on whether this is the
                                    // issues list or features list, so that the highlight color for each will be applied

                                    pageLinks = pageLinks + "<li class='page-item'><span class='page-link iss-selected'>" + page_range[i] + "<span class='sr-only'>(current)</span></span></li>";
                                }
                                else {
                                    pageLinks = pageLinks + "<li class='page-item'><span class='page-link ftr-selected'>" + page_range[i] + "<span class='sr-only'>(current)</span></span></li>";
                                }
                            }
                        }
                        else {

                            if (pageLinks == "") {

                                // Output the class 'iss-page-click' or 'feat-page-click', depending on whether the
                                // list being paginated is for Issues or Features, so that the correct js functions will be 
                                // triggered for each list
                                // Also Output the class 'iss-page-live-link' or 'ftr-page-live-link', depending on whether the
                                // list being paginated is for Issues or Features, so that they will be highlighted with the
                                // correct color on hover

                                if (listType == "issues") {
                                    pageLinks = "<li class='page-item'><a class='page-link iss-page-live-link iss-page-click' href='#' data-value=" + page_range[i] + ">" + page_range[i] + "</a></li>";
                                }
                                else {
                                    pageLinks = "<li class='page-item'><a class='page-link ftr-page-live-link feat-page-click' href='#' data-value=" + page_range[i] + ">" + page_range[i] + "</a></li>";

                                }
                            }
                            else {

                                // Output the class 'iss-page-click' or 'feat-page-click', depending on whether the
                                // list being paginated is for Issues or Features, so that the correct js functions will be 
                                // triggered for each list
                                // Also Output the class 'iss-page-live-link' or 'ftr-page-live-link', depending on whether the
                                // list being paginated is for Issues or Features, so that they will be highlighted with the
                                // correct color on hover

                                if (listType == 'issues') {
                                    pageLinks = pageLinks + "<li class='page-item'><a class='page-link iss-page-live-link iss-page-click' href='#' data-value=" + page_range[i] + ">" + page_range[i] + "</a></li>";
                                }
                                else {

                                    pageLinks = pageLinks + "<li class='page-item'><a class='page-link ftr-page-live-link feat-page-click' href='#' data-value=" + page_range[i] + ">" + page_range[i] + "</a></li>";
                                }

                            }
                        }

                    }

                    if (has_next_page) {

                        // Output the class 'iss-page-click' or 'feat-page-click', depending on whether the
                        // list being paginated is for Issues or Features

                        if (listType == "issues") {

                            var nextPageLink = "<li class='page-item'><a class='page-link iss-page-live-link iss-page-click' href='#' data-value=" + next_page_nr + ">&raquo;</a></li>";
                        }
                        else {

                            var nextPageLink = "<li class='page-item'><a class='page-link ftr-page-live-link feat-page-click' href='#' data-value=" + next_page_nr + ">&raquo;</a></li>";
                        }

                    }
                    else {

                        nextPageLink = "<li class='page-item'><span class='page-link'>&raquo;</span></li>";

                    }

                    var pageNav = prevPageLink + pageLinks + nextPageLink + "</ul>";


                    $("#paginate").append(
                        pageNav
                    );
                }
            }


            // =================================
            // Get the features from the database 
            // =================================

            // Get the relevant features, based on the value of the filters

            function getFeatures(featuresFilter, statusFilter, paidFilter, clientFilter, page, searchValue) {

                console.log("in getFeatures(). page = " + page)

                $.post({
                    url: "{% url 'get_features' %}",

                    data: {
                        csrfmiddlewaretoken: "{{csrf_token}}",
                        featuresFilter: featuresFilter,
                        statusFilter: statusFilter,
                        paidFilter: paidFilter,
                        clientFilter: clientFilter,
                        page: page,
                        searchValue: searchValue,

                    },

                    success: function(data) {

                        console.log("after success")

                        // Display user message if one is returned
                        // If the message is blank, keep the line space, but make
                        // it invisible on the screen

                        var userMessage = data.user_mesg.user_message;
                        console.log("have user_message")

                        if (userMessage != "") {
                            console.log("userMessage: " + userMessage);
                            $('.user-message').text(userMessage);
                            $('.user-message').removeClass('blank-line');
                        }
                        else {
                            $('.user-message').text("blank");
                            $('.user-message').addClass('blank-line');
                        }


                        // Clear the current contents of the table
                        // Output the details of each feature to the table 

                        $("tbody").empty();
                        $.each(data.features, function(key, value) {

                            console.log("in table body")

                            var featureId = value.id;

                            var inputDate = value.date;
                            var user = value.user;

                            // Initialise 'inputDisabled'. To be added to input field
                            // for quantity & amount, to enable / disabled input

                            var inputDisabled = "";

                            // Initialise 'linkEnabledDisabled'. Class To be 
                            // added to thumbs up to enable / disable

                            var linkEnabledDisabled = "";

                            if (value.user_type == "C") {
                                var assignedUser = value.assigned_client_user;
                                linkEnabledDisabled = " ftr-enabled-link"

                            }
                            else {
                                var assignedUser = value.assigned_vendor_user;
                                linkEnabledDisabled = " disabled-link"

                                // For vendor-side user, quantity & +Add will be disabled

                                inputDisabled = "disabled";
                            }

                            var softwareComponent = value.software_component;
                            var summary = value.summary;
                            var status = value.status;
                            var paid = value.paid;
                            var price = value.price;
                            var thumbsUp = value.thumbs_up

                            // Output the Feature Details to the table, including the 'more' icon in the last cell

                            $("tbody").append(
                                "<tr><td class='td-id'>" + featureId + "</td><td class='td-date'>" + inputDate + "</td><td class='td-username'>" + assignedUser + "</td><td class='td-sw-comp'>" + softwareComponent + "</td><td class='td-summary'>" + summary + "</td><td class='text-center td-status'>" + status + "</td><td class='text-center td-price'>" + price + "</td><td class='text-center td-paid'>" + paid + "</td>" +
                                "<form method='post' class='form-inline' action=/cart/add/" + featureId + "/" + ">" + " {% csrf_token %}" + "<div class='input-group'>" + "<td class='pl-0 ml-0 td-thumbs-up'>" + "<button class='" + featureId + " btn ftr-td-thumbs-up-style td-form-font ftr-thumbs-up-click" + linkEnabledDisabled + "' type='submit'" + inputDisabled + "><i class='fas fa-thumbs-up thumbs-up-icon'></i></button>" + "</td></div></form>" + "<td class='text-center td-thumbs-up'>" + thumbsUp + "</td><td class='text-center td-more'><a class='ftr-more-icon-style' href=/issue_tracker/features/" + featureId + "-n" + "/ " + "><i class='fas fa-ellipsis-h more-icon-style'></i></a></td></tr>"
                            );

                            console.log("input date: " + inputDate + " user:  " + user + " summary: " + summary);

                        });

                        // Output the pagination parameters for the features list to the html page

                        let listType = "features"
                        outputPaginationValues(data, listType);

                    },


                    traditional: true
                }).done();
            }

            /*  ================================================================
                THE FOLLOWING FUNCTIONS MANAGE THE FEATURE COMMENTS SHOW / HIDE 
                ================================================================
                           
                The following functions manage the Feature Comments show /hide
            */

            $('#enable-comments').on('click', function() {

                // Enable Comments icon clicked:
                // Show the dashboard, but keep the comments form hidden.
                // The comments form will be enabled by the '+' on the dashboard

                $('#ftr-comments-form').hide();

                $('.ftr-comments-dash').removeClass('d-none').hide();
                $('.ftr-comments-dash').slideDown(500);

                // Disable the 'enable comments' icon 

                $('#enable-comments').removeClass('ftr-enabled-link');
                $('#enable-comments').addClass('disabled-link');

                // Enable the 'disable comments' icon 

                $('#disable-comments').removeClass('disabled-link');
                $('#disable-comments').addClass('iss-enabled-link');


                // Enable the '+' icon - to open form and add comments

                $('#ftr-comments-plus').addClass('iss-enabled-link');
                $('#ftr-comments-plus').removeClass('disabled-link');

                // Disable the '-' icon - this closes the form once its open

                $('#ftr-comments-minus').removeClass('ftr-enabled-link');
                $('#ftr-comments-minus').addClass('disabled-link');

                // Enable the 'open comments list view' icon 

                $('#ftr-comments-open').removeClass('disabled-link');
                $('#ftr-comments-open').addClass('ftr-enabled-link');

                // Disable the 'close comments list view' icon 

                $('#ftr-comments-close').removeClass('ftr-enabled-link');
                $('#ftr-comments-close').addClass('disabled-link');

                console.log("Feature Comments enabled.........................")
            });


            $('#disable-comments').on('click', function() {

                // Disable Comments icon clicked:
                // Hide the comments dashboard, form, and list 

                $('.ftr-comments-dash').slideUp();
                $('#ftr-comments-form').slideUp();
                $('#ftr-comments-list').slideUp();

                // Enable the 'enable comments' icon 

                $('#enable-comments').removeClass('disabled-link');
                $('#enable-comments').addClass('ftr-enabled-link');

                // Disable the 'disable comments' icon 

                $('#disable-comments').removeClass('ftr-enabled-link');
                $('#disable-comments').addClass('disabled-link');


                console.log("Feature Comments disabled.........................")
            });


            $('#ftr-comments-plus').on('click', function() {

                // The '+' on the comments dashboard has been clicked:
                // Show the comments input form

                $('#ftr-comments-form').removeClass('d-none').hide();
                $('#ftr-comments-form').slideDown(500);

                // Disable the '+'

                $('#ftr-comments-plus').removeClass('ftr-enabled-link');
                $('#ftr-comments-plus').addClass('disabled-link');

                // Enable the '-'

                $('#ftr-comments-minus').addClass('ftr-enabled-link');
                $('#ftr-comments-minus').removeClass('disabled-link');


                // Close the comments list view, in case it's open

                $('#ftr-comments-list').slideUp(500);

                // Disable the 'close comments list view' icon

                $('#ftr-comments-close').removeClass('ftr-enabled-link');
                $('#ftr-comments-close').addClass('disabled-link');

                // Enable the 'open comments list view' icon

                $('#ftr-comments-open').addClass('ftr-enabled-link');
                $('#ftr-comments-open').removeClass('disabled-link');
            });


            $('#ftr-comments-minus').on('click', function() {

                // The '-' on the comments dashboard has been clicked:
                // Hide the comments input form

                $('#ftr-comments-form').slideUp(500);

                // Disable the '-'

                $('#ftr-comments-minus').removeClass('ftr-enabled-link');
                $('#ftr-comments-minus').addClass('disabled-link');

                // Enable the '+'

                $('#ftr-comments-plus').addClass('ftr-enabled-link');
                $('#ftr-comments-plus').removeClass('disabled-link');
            });


            $('#ftr-comments-open').on('click', function() {

                // The view comments list icon on the comments dashboard has been 
                // clicked:
                // Show the comments list

                // First, close the comments input form, in case it's open

                $('#ftr-comments-form').slideUp(500);

                // Disable the '-'

                $('#ftr-comments-minus').removeClass('ftr-enabled-link');
                $('#ftr-comments-minus').addClass('disabled-link');

                // Enable the '-'

                $('#ftr-comments-plus').addClass('ftr-enabled-link');
                $('#ftr-comments-plus').removeClass('disabled-link');

                // Show the comments list view

                $('#ftr-comments-list').removeClass('d-none').hide();
                $('#ftr-comments-list').slideDown(500);

                // Disable the 'open comments list view' icon

                $('#ftr-comments-open').removeClass('ftr-enabled-link');
                $('#ftr-comments-open').addClass('disabled-link');

                // Enable the 'close comments list view' icon

                $('#ftr-comments-close').addClass('ftr-enabled-link');
                $('#ftr-comments-close').removeClass('disabled-link');
            });


            $('#ftr-comments-close').on('click', function() {

                // The 'close comments list view' on the comments dashboard has been clicked:
                // Hide the comments list

                $('#ftr-comments-list').slideUp(500);

                // Disable the 'close comments list view' icon

                $('#ftr-comments-close').removeClass('ftr-enabled-link');
                $('#ftr-comments-close').addClass('disabled-link');

                // Enable the 'open comments list view' icon

                $('#ftr-comments-open').addClass('ftr-enabled-link');
                $('#ftr-comments-open').removeClass('disabled-link');

            });

            // Next function here

        });
    </script>

</body>


</html>
