{% extends "base.html" %} {% block content %}

<!-- This form will be used:
     1. To display the details of an issue 
     2. Allow the user to view & enter comments on the issue    -->

<!-- If the user is a vendor-side user, show the name of the client the issue 
     belongs to -->

<div class="row no-gutters">
    <div class="col-12 text-center">
        {% if userdetails.user_type == "V" %}
        <p><strong>Client:</strong>
            <span><strong>{{issueclientdetails.client_name}}</strong></span>
        </p>
        {% endif %}
    </div>
</div>


<!-- Software Component  -->

<div class="form-style">

    <!-- Software Component -->

    <div class="row no-gutters pt-1">
        <div class="col-12 col-md-5">
            <div class="row no-gutters">
                <div class="col-12 form-font">
                    <span><strong>Component: </strong>{{ issue.software_component}}</span>
                </div>
            </div>
        </div>

        <!-- Status -->

        <div class="col-12 col-md-3 form-font pt-1">
            <span><strong>Status: </strong>{{ issue.status }}</span>
        </div>

        <!--  Priority -->

        <div class="col-12 col-md-4 form-font pt-1 position">
            <span><strong>Priority: </strong></span> {% if issue.priority == 1 %}
            <span>1 - URGENT</span> {% else %} {% if issue.priority == 2 %}
            <span>2 - HIGH PRIORITY</span> {% else %} {% if issue.priority == 3 %}
            <span>3 - MEDIUM PRIORITY</span> {% else %} {% if issue.priority == 4 %}
            <span>4 - LOW PRIORITY</span> {% else %} {% if issue.priority == 5 %}
            <span>5 - COSMETIC</span> {% endif %} {% endif %} {% endif %} {% endif %} {% endif %}
        </div>
    </div>

    <div class="row no-gutters pt-1">

        <!-- Assigned User  -->

        {% if userdetails.user_type == "V" %}

        <!-- If the user is a vendor-side user, show who the issue is
                     assigned to on the vendor side -->

        <div class="col-12 col-md-5 form-font ">
            <span><strong>Assigned to: </strong></span>
            <span class="pl-1">{{ issue.assigned_vendor_user}}</span>
        </div>

        {% else %}

        <!-- Client-side user: Show the user the issue is assigned to on the 
         client side -->

        <div class="col-12 col-md-5 form-font">
            <span><strong>Assigned to: </strong></span>
            <span class="pl-1">{{ issue.assigned_client_user}}</span>
        </div>

        {% endif %}

        <!-- Show comments icon -->
        <!-- If comments are being input, disable comments icon and enable no-comments icon -->

        {% if comments_input == 'y' or view_comments == 'y' %}

        <div class="col-12 offset-md-6 col-md-1 icon-height comments-icon-align">
            <a id="enable-comments" class="disabled-link" href="#"><i class="fas fa-comments iss-comments-icon"></i></a>
            <a id="disable-comments" class="iss-enabled-link" href="#"><i class="fas fa-comment-slash iss-no-comments-icon"></i></a>
        </div>

        {% else %}

        <!-- If comments are not being input, enable comments icon and disable no-comments icon -->

        <div class="col-12 offset-md-6 col-md-1 icon-height comments-icon-align">
            <a id="enable-comments" class="enabled-link" href="#"><i class="fas fa-comments iss-comments-icon"></i></a>
            <a id="disable-comments" class="disabled-link" href="#"><i class="fas fa-comment-slash iss-no-comments-icon"></i></a>
        </div>
        
        {% endif %}

    </div>

    <hr>

 <!-- START OF ISSUE COMMENTS SECTIONS ---------------------------------->

    {% if comments_input == 'y' or view_comments == 'y' %}
    
    <!-- COMMENTS ICONS:
        If comments are currently being input display the comments dashboard,
         Or if the comments list is required, display the comments dashboard,
         otherwise, hide it. -->

    <div id="iss-comments-dash" class="row no-gutters mt-3 iss-comments-dash">

        {% if comments_input == 'y' %}
        
        <!-- If the user is entering comments, the form will be open, so,
             Show plus icon disabled (comments form will already be open), show minus icon enabled (to close comments form) -->
        
        <div class="col-2 pl-2">
            <button id="iss-comments-plus" class="btn iss-comments-btn-color disabled-link" type="submit "><i class="fas fa-plus comments-plus-view"></i></button>
            <button id="iss-comments-minus" class="btn iss-comments-btn-color iss-enabled-link " type="submit "><i class="fas fa-minus comments-plus-view"></i></button>
        </div>
        
        <!-- Show view comments icon enabled (to show comments list ), show close-view icon disabled (comments list not currently showing) -->
        
        <div class="offset-8 col-2 text-center ">
            <button id="iss-comments-open" class="btn iss-comments-btn-color iss-enabled-link" type="submit "><i class="far fa-eye comments-plus-view"></i></i></button>
            <button id="iss-comments-close" class="btn iss-comments-btn-color disabled-link" type="submit "><i class="far fa-eye-slash comments-plus-view"></i></i></button>
        </div>
        
        {% else %}
        
        <!-- If the user is has just entered a comment, we are showing the comments list, and the comment form is closed, so
             Show plus icon disabled (comments form will already be open), show minus icon enabled (to close comments form) -->
             
        <div class="col-2 pl-2">
            <button id="iss-comments-plus" class="btn iss-comments-btn-color iss-enabled-link" type="submit "><i class="fas fa-plus comments-plus-view"></i></button>
            <button id="iss-comments-minus" class="btn iss-comments-btn-color disabled-link " type="submit "><i class="fas fa-minus comments-plus-view"></i></button>
        </div>
        
        <!-- Show view comments icon enabled (to show comments list ), show close-view icon disabled (comments list not currently showing) -->
        
        <div class="offset-8 col-2 text-center ">
            <button id="iss-comments-open" class="btn iss-comments-btn-color disabled-link" type="submit "><i class="far fa-eye comments-plus-view"></i></i></button>
            <button id="iss-comments-close" class="btn iss-comments-btn-color iss-enabled-link" type="submit "><i class="far fa-eye-slash comments-plus-view"></i></i></button>
        </div>
        {% endif %}
        
    </div>

    {% else %}

    <!-- Otherwise, hide the comments dashboard and comments form -->
    
    <div id="iss-comments-dash" class="row no-gutters mt-3 iss-comments-dash  d-none">

        <!-- js will show this element, so make plus icon disabled, minus enabled -->

        <div class="col-2 pl-2">
            <button id="iss-comments-plus" class="btn iss-comments-btn-color iss-enabled-link" type="submit "><i class="fas fa-plus comments-plus-view"></i></button>
            <button id="iss-comments-minus" class="btn iss-comments-btn-color disabled-link" type="submit "><i class="fas fa-minus comments-plus-view"></i></button>
        </div>


        <!-- Show view icon -->
        
        <div class="offset-8 col-2 text-center ">
            <button id="iss-comments-open" class="btn iss-comments-btn-color iss-enabled-link" type="submit "><i class="far fa-eye comments-plus-view"></i></i></button>
            <button id="iss-comments-close" class="btn iss-comments-btn-color disabled-link" type="submit "><i class="far fa-eye-slash comments-plus-view"></i></i></button>
        </div>
    </div>
    {% endif %}


    <!-- COMMENTS FORM:
        If comments are currently being input display the comment input form, 
         otherwise hide it.-->

    {% if comments_input == 'y'%}

    <form method="POST" id="iss-comments-form" enctype="multipart/form-data" action="{% url 'new_issue_comment' issue.id %}" class="iss-comments-form-style">

        {% else %}

        <form method="POST" id="iss-comments-form" enctype="multipart/form-data" action="{% url 'new_issue_comment' issue.id %}" class="iss-comments-form-style d-none">

        {% endif %}

            <!-- Set the default value fields -->
            <input name="issue_id" type="hidden" id="issue_id" value="{{ issue.id }}">
            <input name="vend_client_ind" type="hidden" id="vend_client_ind" value="{{ userdetails.user_type }}">
            <input name="vend_client_code" type="hidden" id="vend_client_code" value="{{ issue.client_code }}">
            <input name="user_id" type="hidden" id="user_id" value="{{ userdetails.user_id }}"> {% csrf_token %}

            <!-- Comments field -->
            <div class="row no-gutters">
                <div class="col-12">
                    <textarea name="comments" id="comments" class="form-control form-font" rows="1" maxlength="100"></textarea>
                </div>
            </div>

            <!-- Add Comment Button -->
            <div class="row no-gutters pt-2">
                <div class="col-12 text-center">
                    <button class="btn iss-comments-btn-color iss-enabled-link" type="submit "><i class="fas fa-plus"></i> Add</button>
                </div>
            </div>
        </form>


        <!-- COMMENTS LIST: 
             If the comments list for this issue are currently being view, 
            display the list of comments, otherwise hide it -->

        {% if view_comments == 'y'%}

        <div id="iss-comments-list" class="row no-gutters">
        
        {% else %}
        
        <div id="iss-comments-list" class="row no-gutters d-none">
            
        {% endif %}
        
            <div class="table-responsive ">

                <table class="table table-striped table-style">
                    <thead class="table-hd">
                        <tr>
                            <th scope="col" class="text-center td-date">Date</th>
                            <th scope="col" class="text-center td-username">Vendor / Client</th>
                            <th scope="col" class="text-center td-username">Author</th>
                            <th scope="col" class="text-center td-comments">Comments</th>
                        </tr>
                    </thead>

                    <!-- Show the date, author (user) and comments -->
                    
                    <tbody>
                        {% for issuecomment in issuecomments %}
                        <tr>
                            <td class="d-table-cell td-date">{{ issuecomment.input_date|date:"d M y" }}</td>
                            
                            {% if issuecomment.vend_client_ind == "V" %}
                            <td class="d-table-cell td-username text-center">Vendor</td>
                            {% else %}
                             <td class="d-table-cell td-username text-center">Client</td>
                             {% endif %}

                            <!-- Vendor-side users can see all user ids, client-side users can see the comment user ids of 
                                 users associated with the same client as them, and the user ids of vendor-users -->
                            
                            {% if userdetails.user_type == "V" or userdetails.vend_client_code == issuecomment.vend_client_code or issuecomment.vend_client_ind == "V" %}
                            
                            <td class="d-table-cell td-username">{{ issuecomment.user_id }}</td>
                            
                            {% else %}
                            
                            <td class="d-table-cell td-username">**********</td>
                            
                            {% endif %} 

                            <td class="td-summary">{{ issuecomment.comments }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <hr>
            </div>
        </div>


        <!-- END OF ISSUE COMMENTS SECTIONS --------------------------------   -->


        <!-- Issue Title -->

        <div class="row no-gutters mt-3">
            <div class="col-12 offset-md-2 offset-xl-3 col-md-8 col-xl-6 form-font">
                <p class="m-0"><strong><em>TITLE:</em></strong></p>
            </div>
        </div>


        <div class="row no-gutters">
            <div class="col-12 offset-md-2 offset-xl-3 col-md-8 col-xl-6">
                <p class="m-0">{{ issue.title }}</p>
            </div>
        </div>



        <!-- Summary -->

        <div class="row no-gutters mt-3">
            <div class="col-12 form-font offset-md-2 offset-xl-3 col-md-8 col-xl-6">
                <p class="m-0"><strong><em>SUMMARY:</em></strong></p>
            </div>
        </div>

        <div class="row no-gutters">
            <div class="col-12 form-font offset-md-2 offset-xl-3 col-md-8 col-xl-6">
                <p class="m-0">{{ issue.summary }}</p>
            </div>
        </div>


        <!-- Details  -->

        <div class="row no-gutters mt-3">
            <div class="col-12 form-font offset-md-2 offset-xl-3 col-md-8 col-xl-6">
                <p class="m-0"><strong><em>DETAILS:</em></strong></p>
            </div>
        </div>

        <div class="row no-gutters ">
            <div class="col-12 form-font offset-md-2 offset-xl-3 col-md-8 col-xl-6">
                <p class="m-0">{{ issue.details }}
                    <p>
            </div>
        </div>



        <!-- Edit Button 
          If the issue is assigned to the logged in user, on the client side or
          on the vendor side, enable the Edit button, otherwise disable it. -->

        <hr>
        <div class="row no-gutters mt-2">
            <div class="col-12 offset-md-2 offset-xl-3 col-md-8 col-xl-6 text-center">

                {% if userdetails.user_type == "C" %} {% if userdetails.user_id == issue.assigned_client_user %}

                <!-- User is a client-side user.
                         Is the issue assigned, to the logged in user, 
                         and is the status = DRAFT or LOGGED? 
                         If so, enable the Edit button, otherwise disable it -->

                {% if issue.status == "DRAFT" or issue.status == "LOGGED" %}

                <a href="{% url 'edit_issue' issue.id %}" class="btn iss-edit-update-btn-color ">Edit</a> {% else %}
                <span class="btn iss-edit-update-btn-color disabled-link" type="submit ">Edit</span> {% endif %} {% endif %} {% else %}

                <!-- User is a vendor-side user.
                        Is the issue assigned to the logged in user? 
                        If so, allow the user to update the issue status -->

                {% if userdetails.user_id == issue.assigned_vendor_user %}

                <a href="{% url 'update_issue_status' issue.id %}" class="btn iss-edit-update-btn-color ">Update Status</a> {% endif %} {% endif %}

            </div>
        </div>
</div>



{% endblock %}
